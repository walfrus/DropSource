<script>
// --- config & dom refs -------------------------------------------------------
const API = '/api/smm';
const elQ = document.getElementById('q');
const elCat = document.getElementById('cat');
const elWrap = document.getElementById('wrap');

// controls
(document.getElementById('reload')||{}).onclick = load;
(document.getElementById('expandAll')||{}).onclick = ()=>document.querySelectorAll('.section').forEach(s=>s.classList.add('open'));
(document.getElementById('collapseAll')||{}).onclick = ()=>document.querySelectorAll('.section').forEach(s=>s.classList.remove('open'));
elQ.oninput = load; elCat.onchange = load;

function showErr(m){ console.error(m); alert(m); }

// --- platform meta -----------------------------------------------------------
const PLATFORM_COLORS = {
  Instagram:'#E1306C', Telegram:'#2CA5E0', Twitter:'#1DA1F2', X:'#0F1419',
  TikTok:'#EE1D52', Facebook:'#1877F2', YouTube:'#FF0000', Spotify:'#1DB954',
  SoundCloud:'#FF5500', Threads:'#000000', VK:'#4C75A3', Twitch:'#9146FF',
  Reddit:'#FF4500', Pinterest:'#E60023', LinkedIn:'#0A66C2', Snapchat:'#FFFC00',
  Discord:'#5865F2', Shazam:'#0088FF', Vimeo:'#1AB7EA', Quora:'#B92B27',
  Mixcloud:'#273A4B', 'OK.ru':'#F4731C', Audiomack:'#FFA200', Dailymotion:'#0066DC',
  Reverbnation:'#000000', Tumblr:'#35465C', WhatsApp:'#25D366',
  Website:'#59a0ff', Mobile:'#59a0ff', Crypto:'#f7931a', GeoTarget:'#59a0ff',
  GoogleReviews:'#34a853', OwnWebsite:'#59a0ff', MaskedTraffic:'#59a0ff',
  Podcast:'#ffa500', MassDM:'#59a0ff', Exchange:'#59a0ff', Other:'#59a0ff'
};

function detectPlatform(str=''){
  const s = String(str).toLowerCase();
  const map = [
    ['Instagram',/(^|\b)(instagram|ig)\b/],
    ['Telegram',/(^|\b)(telegram|tg)\b/],
    ['Twitter',/(^|\b)twitter\b/],
    ['X',/(^|\b)x\b(?![a-z])/],
    ['TikTok',/(^|\b)(tiktok|tt)\b/],
    ['Facebook',/(^|\b)(facebook|fb)\b/],
    ['YouTube',/(^|\b)(youtube|yt|shorts)\b/],
    ['Spotify',/spotify/],
    ['SoundCloud',/soundcloud/],
    ['Threads',/(^|\b)threads?\b/],
    ['VK',/(^|\b)vk\b|vkontakte/],
    ['Twitch',/twitch/],
    ['Reddit',/reddit/],
    ['Pinterest',/pinterest/],
    ['LinkedIn',/(^|\b)linkedin\b/],
    ['Snapchat',/snapchat/],
    ['Discord',/discord/],
    ['Shazam',/shazam/],
    ['Vimeo',/vimeo/],
    ['Quora',/quora/],
    ['Mixcloud',/mixcloud/],
    ['OK.ru',/ok\.?ru|(^|\b)ok\b/],
    ['Audiomack',/audiomack/],
    ['Dailymotion',/dailymotion/],
    ['Reverbnation',/reverbnation/],
    ['Tumblr',/tumblr/],
    ['WhatsApp',/whatsapp/],
    ['Website',/\bwebsite\b|web ?traffic|seo|site traffic|webtraffic/],
    ['Mobile',/\bmobile\b|app installs?/],
    ['Crypto',/crypto|bitcoin|\bbtc\b|\beth\b|ethereum/],
    ['GeoTarget',/\bgeo|country|region|target/],
    ['GoogleReviews',/google ?reviews?/],
    ['OwnWebsite',/ownwebsite|own website/],
    ['MaskedTraffic',/masked ?traffic/],
    ['Podcast',/podcast/],
    ['MassDM',/mass ?dm/],
    ['Exchange',/exchange/],
  ];
  for (const [name,rx] of map) if (rx.test(s)) return name;
  return 'Other';
}

// --- typing & summarization --------------------------------------------------
const TYPE_PATTERNS = [
  ['Followers', /follows?|followers?|subs?(cribers?)?/i],
  ['Likes', /likes?/i],
  ['Views', /views?|plays?|watch(?: ?time)?/i],
  ['Comments', /comments?/i],
  ['Saves', /saves?/i],
  ['Shares', /shares?|reposts?/i],
  ['Impressions', /impressions?/i],
  ['Votes', /votes?|poll/i],
  ['Members', /members?/i],
  ['Mentions', /mentions?/i],
  ['Story', /story|stories/i],
  ['Live', /live\b/i],
  ['Traffic', /traffic|visits?/i],
  ['Other', /.*/]
];
function getBaseType(name){ for(const [label,rx] of TYPE_PATTERNS) if (rx.test(name)) return label; return 'Other'; }

function slugify(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
function formatK(n){ n = Number(n||0); if(n>=1_000_000) return (n/1_000_000).toFixed(n%1_000_000?1:0)+'M'; if(n>=1_000) return (n/1_000).toFixed(n%1_000?1:0)+'K'; return String(n); }
function escapeHtml(x){ return x?.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))||'' }
function stripEmojis(str){ return String(str||'').replace(/[\u{1F300}-\u{1FAFF}\u{2600}-\u{27BF}\u{1F1E6}-\u{1F1FF}]/gu,''); }
function baseLabel(name){ const s = stripEmojis(String(name||'')); const cut = s.split(/[\[|]/)[0]; return cut.replace(/smmgoal/ig,'').replace(/\s+/g,' ').trim(); }

function extractMeta(name){
  const s = String(name||'');
  const chips = [];
  const add = (t,kind='gray')=>chips.push({text:t,kind});
  // refill
  const r1 = s.match(/(\d{1,3})\s*Days?\s*Refill/i); if(r1) add(`Refill ${r1[1]}d`,'green');
  const r2 = s.match(/\bR(B)?(\d{1,3})\b/i); if(r2) add(`Refill ${r2[2]}d`,'green');
  if(/no\s*refill|non\s*refill|no\s*support/i.test(s)) add('No refill','amber');
  // speed / start
  if(/instant|0-?\s*\d+\s*min/i.test(s)) add('Instant','green');
  const spd = s.match(/speed[:\s]*(\d+[kKmM]?)[^\w]*/i); if(spd) add(`Speed ${spd[1]}/d`,'blue');
  // quality / drop
  if(/no\s*drop|non\s*drop/i.test(s)) add('No drop','purple');
  if(/hq|high\s*quality|premium/i.test(s)) add('HQ','purple');
  if(/cheap|cheapest/i.test(s)) add('Cheapest','amber');
  // geo (lightweight)
  const geos = ['USA','US','UK','Germany','France','Italy','Spain','Brazil','Korea','Japan','India','Turkey','Canada'];
  for(const g of geos){ const rx = new RegExp(`\\b${g}\\b`,'i'); if(rx.test(s)){ add(g.toUpperCase(),'blue'); break; } }
  return chips;
}

function summarizeVariant(svc, plat, type){
  const label = baseLabel(svc.name) || type || 'Variant';
  const chips = extractMeta(svc.name);
  chips.unshift({text:`Min ${formatK(svc.min)}`,kind:'gray'});
  chips.unshift({text:`Max ${formatK(svc.max)}`,kind:'gray'});
  return {label, chips};
}

// --- data load & rendering ---------------------------------------------------
async function load(){
  const q = encodeURIComponent(elQ.value||'');
  const cat = encodeURIComponent(elCat.value||'');
  const url = `${API}?action=services${q?`&q=${q}`:''}${cat?`&category=${cat}`:''}`;
  let res, data; try{ res = await fetch(url); data = await res.json(); } catch { showErr('Failed to load services'); return; }
  if(!Array.isArray(data)){ showErr(data?.error||'Failed to load services'); return; }

  // group by platform -> base type
  const byPlat = new Map();
  for(const s of data){
    const plat = detectPlatform(`${s.category||''} ${s.name||''}`);
    const type = getBaseType(s.name||'');
    if(!byPlat.has(plat)) byPlat.set(plat, new Map());
    const m = byPlat.get(plat); if(!m.has(type)) m.set(type, []);
    m.get(type).push(s);
  }

  // fill category select once
  if(!elCat.dataset.filled){
    const plats = [...byPlat.keys()].sort();
    for(const p of plats){ const o=document.createElement('option'); o.value=p; o.textContent=p; elCat.appendChild(o); }
    elCat.dataset.filled='1';
  }

  // render
  elWrap.innerHTML = '';

  // top-level category cards (by platform)
  const catsGrid = document.createElement('div');
  catsGrid.className = 'grid';
  for (const [p, m] of byPlat) {
    const catCard = document.createElement('div');
    catCard.className = 'card';
    catCard.style.borderTop = `3px solid ${PLATFORM_COLORS[p] || PLATFORM_COLORS.Other}`;
    catCard.innerHTML = `
      <h3 style="display:flex;justify-content:space-between;align-items:center">
        <span>${escapeHtml(p)}</span>
        <span class="chip s gray">${countServices(m)} services</span>
      </h3>
      <div class="muted">Click to explore</div>
    `;
    catCard.onclick = () => {
      const sec = elWrap.querySelector(`section[data-plat="${p}"]`);
      if (sec) { sec.classList.add('open'); sec.scrollIntoView({behavior:'smooth', block:'start'}); }
    };
    catsGrid.appendChild(catCard);
  }
  elWrap.appendChild(catsGrid);

  const want = elCat.value;
  for(const [plat, byType] of byPlat){
    if(want && plat!==want) continue;
    const color = PLATFORM_COLORS[plat] || PLATFORM_COLORS.Other;

    const sec = document.createElement('section');
    sec.className='section';
    sec.setAttribute('data-plat', plat);
    sec.style.setProperty('--plat', color);
    sec.innerHTML = `
      <div class="head">
        <div class="row">
          <span class="chip blue s">${plat}</span>
          <span class="chip gray s">${countServices(byType)} services</span>
        </div>
        <div class="muted">Toggle</div>
      </div>
      <div class="body"><div class="grid"></div></div>
    `;
    sec.querySelector('.head').addEventListener('click', ()=>sec.classList.toggle('open'));

    const grid = sec.querySelector('.grid');
    for(const [type, list0] of byType){
      // sort by price ascending, keep all (no aggressive min/max filter so categories don't disappear)
      const list = list0.slice().sort((a,b)=>a.price_per_1k - b.price_per_1k);
      if (!list.length) continue;
      const cheapest = list[0];

      const card = document.createElement('div');
      card.className='card';
      card.innerHTML = `
        <h3>
          <span class="brand" style="color:var(--brand);font-weight:700">DropSource</span>
          <span class="muted">Â·</span>
          <span style="color:#cdd7ff">${escapeHtml(plat)}</span>
          <span class="muted">/</span>
          <span style="color:#cdd7ff">${escapeHtml(type)}</span>
        </h3>
        <div class="row">
          <span class="chip s gray">Min ${formatK(cheapest.min)}</span>
          <span class="chip s gray">Max ${formatK(cheapest.max)}</span>
          ${/drip/i.test(cheapest.name)?'<span class="chip s purple">Dripfeed</span>':''}
          ${/refill/i.test(cheapest.name)?'<span class="chip s green">Refill</span>':''}
        </div>
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="price">$${cheapest.price_per_1k.toFixed(2)} <span class="muted">/ 1k</span></div>
          <div class="row">
            <button class="btn"
              onclick="orderClick(this)"
              data-id="${cheapest.id}"
              data-plat="${escapeHtml(plat)}"
              data-type="${escapeHtml(type)}"
              data-rate="${cheapest.price_per_1k}"
              data-min="${cheapest.min}"
              data-max="${cheapest.max}"
              data-title="${escapeHtml(cheapest.name)}"
              data-name="${escapeHtml(type)}"
              data-slug="${slugify(`${plat} ${type}`)}"
            >Order cheapest</button>
            <button class="btn" data-expand>View variants</button>
          </div>
        </div>
      `;

      const det = document.createElement('details');
      det.style.marginTop='6px';
      det.innerHTML = `<summary>Variants (${list.length})</summary><div></div>`;
      const vWrap = det.querySelector('div');

      for(const svc of list){
        const {label, chips} = summarizeVariant(svc, plat, type);
        const row = document.createElement('div');
        row.className='variant';
        row.innerHTML = `
          <div class="row" style="gap:6px;align-items:baseline">
            <div style="font-size:13px;color:#d7e2f0">${escapeHtml(label)}</div>
            ${chips.map(t=>`<span class="chip s ${t.kind}">${escapeHtml(t.text)}</span>`).join('')}
          </div>
          <div class="row">
            <div class="price" style="font-size:13px">$${svc.price_per_1k.toFixed(2)} <span class="muted">/1k</span></div>
            <button class="btn"
              onclick="orderClick(this)"
              data-id="${svc.id}"
              data-plat="${escapeHtml(plat)}"
              data-type="${escapeHtml(type)}"
              data-rate="${svc.price_per_1k}"
              data-min="${svc.min}"
              data-max="${svc.max}"
              data-title="${escapeHtml(svc.name)}"
              data-name="${escapeHtml(type)}"
              data-slug="${slugify(`${plat} ${type}`)}"
            >Order</button>
          </div>`;
        vWrap.appendChild(row);
      }
      card.appendChild(det);
      card.querySelector('[data-expand]').onclick=()=>det.open=!det.open;
      grid.appendChild(card);
    }
    elWrap.appendChild(sec);
  }
}

function countServices(map){ let n=0; for(const [,arr] of map) n+=arr.length; return n; }

// --- order redirect ----------------------------------------------------------
function orderClick(btn){
  const d = btn.dataset;
  const qs = new URLSearchParams({
    id: d.id||'', name: d.name||'', title: d.title||'', plat: d.plat||'', type: d.type||'',
    rate: d.rate||'', min: d.min||'', max: d.max||'', slug: d.slug||'', link: ''
  });
  location.href = `/purchase.html?${qs.toString()}`;
}

// kick off
load();
</script>