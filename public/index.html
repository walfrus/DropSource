<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DropSource — SMM</title>
  <style>
    :root{
      --bg:#0b0b0f;
      --card:#15161a;
      --txt:#e8ecf1;
      --muted:#a6acb3;
      --brand:#59a0ff;
      --accent:#8b5cf6;          /* price purple */
      --chip:#1b1d23;
      --chip-active:#2a1e3a;
      --chip-border:#2b2f38;
      --rule:#26282d;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto}

    header{
      padding:24px 16px;display:flex;gap:12px;align-items:center;justify-content:space-between;
      border-bottom:1px solid var(--rule);
    }
    .container{max-width:1100px;margin:0 auto;padding:16px}

    input,select,button{
      background:#11131a;border:1px solid #2a2d34;color:var(--txt);padding:10px 12px;border-radius:10px
    }
    button{cursor:pointer}

    /* CATEGORY CHIPS BAR */
    .catsbar{display:flex;gap:8px;align-items:center;overflow:auto;padding:8px 2px 0;scrollbar-width:none}
    .catsbar::-webkit-scrollbar{display:none}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      background:var(--chip);border:1px solid var(--chip-border);
      color:var(--txt);padding:8px 12px;border-radius:999px;white-space:nowrap;cursor:pointer;
      transition:.15s ease transform,.15s ease background,.15s ease border-color;
    }
    .chip:hover{transform:translateY(-1px)}
    .chip.active{
      background:linear-gradient(135deg,#221831,var(--chip-active));
      border-color:#3b3052;
      box-shadow:0 0 0 1px rgba(167,139,250,.15) inset;
    }
    .chip img.ico{width:16px;height:16px;display:block}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-top:12px}
    .card{background:var(--card);border:1px solid #24262c;border-radius:14px;padding:14px}
    .card h3{margin:0 0 6px 0;font-size:16px}
    .muted{color:var(--muted)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{padding:3px 8px;border-radius:999px;background:#1c2028;color:#b9c2cc;font-size:12px}

    .footer{opacity:.7;font-size:12px;padding:18px;text-align:center}
    .brand{color:var(--brand)}
    .price strong{font-weight:700;color:var(--accent);text-shadow:0 0 10px rgba(139,92,246,.15)}
    .price .per{color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div><strong class="brand">DropSource</strong> · Boosts</div>
    <div class="row">
      <input id="q" placeholder="Search services…" />
      <select id="cat" style="display:none"><option value="">All categories</option></select>
      <button id="reload">Reload</button>
    </div>
  </header>

  <div class="container">
    <div id="catsbar" class="catsbar" aria-label="Categories"></div>
    <div id="services" class="grid"></div>
  </div>

  <div class="footer">Powered by DropSource • your growth plug, but like… responsibly ✌️</div>

<script>
const elQ = document.getElementById('q');
const elCat = document.getElementById('cat'); // hidden fallback
const elCatsBar = document.getElementById('catsbar');
const elGrid = document.getElementById('services');
const elReload = document.getElementById('reload');

let ALL_SERVICES = [];
let ACTIVE_CAT = ''; // platform slug

/* ---------------- icons + slugs (unchanged from last version) ---------------- */
/* ICON_PATHS + PLATFORM_RULES + getPlatformSlug() + slugLabel() from previous file — keep that part the same */

/* ---------------- cleaning + dedupe ---------------- */

const PRODUCT_WORDS = [
  'Followers','Likes','Views','Comments','Subscribers','Saves','Story Views',
  'Impressions','Shares','Reposts','Mentions','Retweets','Replies','Quotes',
  'Plays','Streams','Downloads','Members','Votes'
];

function cleanNoise(str='') {
  return String(str)
    .replace(/\[[^\]]*?\]/g, ' ')           
    .replace(/%100|% ?\d{2,3}/gi, ' ')      
    .replace(/\bWORKING AFTER UPDATE\b/gi, ' ')
    .replace(/\bProvider Service\b/gi, ' ')
    .replace(/\bR\d+\b/g, ' ')              
    .replace(/\d{2}\.\d{2}\.\d{4}/g, ' ')   
    .replace(/[\u2190-\u21FF\u2300-\u27BF\u2600-\u27EF]/g,' ') 
    .replace(/[-–—]{2,}/g, '—')
    .replace(/\s+/g, ' ')
    .trim();
}

function extractProduct(name='', category='') {
  const hay = `${name} ${category}`.toLowerCase();
  for (const w of PRODUCT_WORDS) {
    const re = new RegExp(`\\b${w.toLowerCase().replace(/\s+/g,'\\s*')}\\b`, 'i');
    if (re.test(hay)) return w;
  }
  if (/follow/i.test(hay)) return 'Followers';
  if (/like/i.test(hay)) return 'Likes';
  if (/view/i.test(hay)) return 'Views';
  if (/comment/i.test(hay)) return 'Comments';
  if (/sub/i.test(hay)) return 'Subscribers';
  if (/save/i.test(hay)) return 'Saves';
  if (/impression/i.test(hay)) return 'Impressions';
  if (/share/i.test(hay)) return 'Shares';
  return 'Service';
}

function prettyTitle(svc){
  const platform = slugLabel(getPlatformSlug(svc.category || svc.name || 'other'));
  const baseName = cleanNoise(svc.name ?? svc.title ?? svc.category ?? 'Service');
  const product  = extractProduct(baseName, svc.category || '');
  return `${platform} ${product}`;
}

function uniqueServices(services) {
  const seen = new Set();
  return services.filter(s => {
    const key = `${getPlatformSlug(s.category || s.name || '')}|${extractProduct(s.name||'', s.category||'')}`;
    if (seen.has(key)) return false;
    seen.add(key);
    return true;
  });
}

/* ---------------- app logic ---------------- */

async function fetchServices() {
  const res = await fetch('/api/services');
  const data = await res.json();

  ALL_SERVICES = uniqueServices(data); // <= dedupe

  buildCategories(ALL_SERVICES);
  renderServices(filterServices());
}

function buildCategories(data){
  const counts = new Map();
  data.forEach(s=>{
    const slug = getPlatformSlug(s.category);
    counts.set(slug, (counts.get(slug)||0) + 1);
  });

  elCatsBar.innerHTML = '';
  elCatsBar.appendChild(chipNode('All products', `/icons/${ICON_PATHS.other}`, '' ));

  const priority = ['instagram','tiktok','youtube','facebook','spotify','telegram','twitter','x','threads','soundcloud','snapchat','reddit','linkedin','twitch','pinterest','discord','quora','tumblr','vimeo','okru','vk','kick','clubhouse','audiomack'];
  const ordered = [
    ...priority.filter(p=>counts.has(p)),
    ...[...counts.keys()].filter(k=>!priority.includes(k)).sort((a,b)=>counts.get(b)-counts.get(a))
  ];

  for (const slug of ordered){
    const label = `${slugLabel(slug)}`;
    elCatsBar.appendChild(chipNode(label, `/icons/${ICON_PATHS[slug]||ICON_PATHS.other}`, slug));
  }
  updateActiveChip();
}

function chipNode(label, iconPath, value){
  const node = document.createElement('button');
  node.type = 'button';
  node.className = 'chip';
  node.dataset.value = value;
  node.innerHTML = `<img src="${iconPath}" class="ico" alt=""> <span>${label}</span>`;
  node.addEventListener('click', ()=>{
    ACTIVE_CAT = value;
    updateActiveChip();
    renderServices(filterServices());
  });
  return node;
}

function updateActiveChip(){
  [...elCatsBar.querySelectorAll('.chip')].forEach(ch=>{
    ch.classList.toggle('active', ch.dataset.value === ACTIVE_CAT);
  });
}

function filterServices(){
  const q = (elQ.value || '').toLowerCase();
  return ALL_SERVICES.filter(s=>{
    const hay = `${s.name} ${s.title} ${s.category}`.toLowerCase();
    const matchesGroup = !ACTIVE_CAT || getPlatformSlug(s.category) === ACTIVE_CAT;
    return matchesGroup && (!q || hay.includes(q));
  });
}

function renderServices(services) {
  elGrid.innerHTML = services.map(s => {
    const titleText = prettyTitle(s);
    const price = (typeof s.price_per_1k === 'number' && isFinite(s.price_per_1k))
      ? `$${s.price_per_1k.toFixed(2)}`
      : '-';
    const maxLine = s.max ? `Max ${Number(s.max).toLocaleString()}` : '';

    return `
      <div class="card">
        <h3><span class="brand">[DropSource]</span> — ${escapeHtml(titleText)}</h3>
        <div class="muted">${escapeHtml(maxLine)}</div>
        <div class="row" style="margin:8px 0 10px">
          ${s.min ? `<span class="pill">Min ${s.min}</span>` : ''}
          ${s.max ? `<span class="pill">Max ${s.max}</span>` : ''}
          ${s.dripfeed ? '<span class="pill">Dripfeed</span>' : ''}
          ${s.refill ? '<span class="pill">Refill</span>' : ''}
        </div>
        <div class="row" style="justify-content:space-between">
          <div class="price"><strong>${price}</strong> <span class="per">/ 1k</span></div>
          <button onclick='openOrder(${JSON.stringify(s)})'>Order</button>
        </div>
      </div>
    `;
  }).join('');
}

function escapeHtml(x){return x?.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))||''}

async function placeOrder(serviceId, link, quantity, runs, interval) {
  const res = await fetch('/api/order', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ service: serviceId, link, quantity, runs, interval })
  });
  return res.json();
}

function openOrder(svc){
  const link = prompt('Paste the target link (post/profile URL):'); if(!link) return;
  const qty = Number(prompt(`Quantity (min ${svc.min}, max ${svc.max})`));
  if(!qty || qty < svc.min || qty > svc.max){ alert('Quantity out of range'); return; }
  placeOrder(svc.id, link, qty).then(r=>{
    if(r.error) alert('Error: '+r.error);
    else alert('Order placed! ID: '+r.order);
  }).catch(e=>alert('Network issue: '+e.message));
}

/* events */
elQ.addEventListener('input', ()=>renderServices(filterServices()));
elReload.addEventListener('click', fetchServices);

fetchServices();
</script>
</body>
</html>