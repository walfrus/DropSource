<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DropSource — SMM</title>
  <style>
    :root{
      --bg:#0b0b0f; --card:#15161a; --txt:#e8ecf1; --muted:#a6acb3;
      --stroke:#24262c; --chip:#1c2028; --brand:#59a0ff; --shadow:0 6px 24px rgba(0,0,0,.35);
      /* soft chips */
      --c-blue:hsla(210,90%,60%,.16); --t-blue:#a3c5ff;
      --c-green:hsla(150,55%,55%,.16); --t-green:#b9f1d6;
      --c-amber:hsla(40,85%,60%,.16);  --t-amber:#f4d3a5;
      --c-purple:hsla(265,60%,65%,.16);--t-purple:#d4c0ff;
      --c-gray:hsla(220,12%,60%,.14);  --t-gray:#cbd3db;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
    header{padding:16px;display:flex;gap:12px;align-items:center;justify-content:space-between;border-bottom:1px solid var(--stroke);position:sticky;top:0;background:linear-gradient(180deg,rgba(11,11,15,.95),rgba(11,11,15,.85));backdrop-filter:saturate(120%) blur(6px);z-index:10}
    .brand{color:var(--brand);font-weight:700}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    input,select,button{background:#11131a;border:1px solid var(--stroke);color:var(--txt);padding:10px 12px;border-radius:10px}
    button{cursor:pointer}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .chip{padding:3px 8px;border-radius:999px;background:var(--chip);color:#b9c2cc;font-size:12px;border:1px solid rgba(255,255,255,.04)}
    .chip.s{font-size:11px;padding:2px 6px}
    .chip.blue{background:var(--c-blue);color:var(--t-blue)}
    .chip.green{background:var(--c-green);color:var(--t-green)}
    .chip.amber{background:var(--c-amber);color:var(--t-amber)}
    .chip.purple{background:var(--c-purple);color:var(--t-purple)}
    .chip.gray{background:var(--c-gray);color:var(--t-gray)}

    .section{border:1px solid var(--stroke);border-radius:14px;overflow:hidden;margin-bottom:14px;box-shadow:var(--shadow)}
    .section > .head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:#111218;border-bottom:1px solid var(--stroke);cursor:pointer}
    .section > .body{padding:14px;display:none}
    .section.open > .body{display:block}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:12px}

    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:10px;transition:border-color .15s, box-shadow .15s, background .15s}
    .section:hover .card{background:linear-gradient(0deg, rgba(255,255,255,.01), transparent)}
    .card:hover{border-color:var(--plat, var(--brand)); box-shadow:0 0 0 1px var(--plat, var(--brand)) inset, var(--shadow)}
    .card h3{margin:0;font-size:15px;line-height:1.35}
    .price{font-weight:700}
    .btn{padding:8px 10px;border-radius:10px;background:#10131a;border:1px solid var(--stroke)}
    .btn:hover{border-color:var(--plat, #7aa9ff)}
    .footer{opacity:.7;font-size:12px;padding:18px;text-align:center}

    details{background:#12141b;border:1px dashed rgba(255,255,255,.06);border-radius:12px}
    details>summary{list-style:none;padding:8px 10px;cursor:pointer;color:var(--muted)}
    details[open]>summary{color:#d6deea}
    .variant{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-top:1px solid rgba(255,255,255,.04)}
    .toolbar{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <header>
    <div><strong class="brand">DropSource</strong> · Boosts</div>
    <div class="row">
      <input id="q" placeholder="Search services…"/>
      <select id="cat"><option value="">All platforms</option></select>
      <div class="toolbar">
        <button id="expandAll" class="btn">Expand all</button>
        <button id="collapseAll" class="btn">Collapse all</button>
        <button id="reload" class="btn">Reload</button>
      </div>
    </div>
  </header>

  <div class="container" id="wrap"></div>
  <div class="footer">Powered by <span class="brand">DropSource</span> • your growth plug, but like… responsibly ✌️</div>

<script>
const API = '/api/smm';
const elQ = document.getElementById('q');
const elCat = document.getElementById('cat');
const elWrap = document.getElementById('wrap');

document.getElementById('reload').onclick = load;
document.getElementById('expandAll').onclick = ()=>document.querySelectorAll('.section').forEach(s=>s.classList.add('open'));
document.getElementById('collapseAll').onclick = ()=>document.querySelectorAll('.section').forEach(s=>s.classList.remove('open'));
elQ.oninput = load; elCat.onchange = load;

function showErr(m){ console.error(m); alert(m); }

/* ---------- PRICE NORMALIZATION + FLOOR ---------- */
// Adjust these if you want to force minimum display price per 1k:
const MIN_DISPLAY_PER_1K = 0.49;   // never show below this (visual floor)
const PRICE_ENDING_99 = false;      // set true to show .99 endings

function normalizePrice(svc){
  // prefer server fields, fallback to raw panel "rate"
  let p = Number(svc.price_per_1k ?? svc.rate ?? svc.price ?? 0);
  if (!isFinite(p) || p <= 0) p = 0;

  // If it looks like a TOTAL package price (huge) and max known, convert to per-1k
  if (p > 1000 && Number(svc.max) > 0) {
    p = (p / Number(svc.max)) * 1000;
  }

  // If it looks suspiciously tiny (likely per-unit), try scaling using min
  if (p > 0 && p < 0.02 && Number(svc.min) >= 100) {
    p = p * (Math.max(1000, Number(svc.min)) / 1); // scale to /1k
  }

  // visual floor so you don't advertise $0.01/1k
  if (p < MIN_DISPLAY_PER_1K) p = MIN_DISPLAY_PER_1K;

  // pretty .99 ending (optional)
  if (PRICE_ENDING_99) {
    p = Math.floor(p) + 0.99;
  }

  return p;
}

/* ---------- PLATFORM DETECT / TYPE DETECT ---------- */
const PLATFORM_COLORS = {
  Instagram:'#E1306C', Telegram:'#2CA5E0', Twitter:'#1DA1F2', X:'#0F1419',
  TikTok:'#EE1D52', Facebook:'#1877F2', YouTube:'#FF0000', Spotify:'#1DB954',
  SoundCloud:'#FF5500', Threads:'#000000', VK:'#4C75A3', Twitch:'#9146FF',
  Reddit:'#FF4500', Pinterest:'#E60023', LinkedIn:'#0A66C2', Snapchat:'#FFFC00',
  Discord:'#5865F2', Shazam:'#0088FF', Vimeo:'#1AB7EA', Quora:'#B92B27',
  Mixcloud:'#273A4B', 'OK.ru':'#F4731C', Audiomack:'#FFA200', Dailymotion:'#0066DC',
  Reverbnation:'#000000', Tumblr:'#35465C', WhatsApp:'#25D366', Other:'#59a0ff'
};

function detectPlatform(str=''){
  const s = String(str).toLowerCase();
  const map = [
    ['Instagram',/insta|igg?\b/],
    ['Telegram',/telegram|tg\b/],
    ['Twitter',/\btwitter\b|\bx\b/],
    ['TikTok',/tiktok|tt\b/],
    ['Facebook',/facebook|fb\b/],
    ['YouTube',/youtube|yt\b/],
    ['Spotify',/spotify/],
    ['SoundCloud',/soundcloud/],
    ['Threads',/threads\b/],
    ['VK',/\bvk\b|vkontakte/],
    ['Twitch',/twitch/],
    ['Reddit',/reddit/],
    ['Pinterest',/pinterest/],
    ['LinkedIn',/linkedin/],
    ['Snapchat',/snapchat/],
    ['Discord',/discord/],
    ['Shazam',/shazam/],
    ['Vimeo',/vimeo/],
    ['Quora',/quora/],
    ['Mixcloud',/mixcloud/],
    ['OK.ru',/ok\.?ru|\bok\b/],
    ['Audiomack',/audiomack/],
    ['Dailymotion',/dailymotion/],
    ['Reverbnation',/reverbnation/],
    ['Tumblr',/tumblr/],
    ['WhatsApp',/whatsapp/],
  ];
  for (const [name,rx] of map) if (rx.test(s)) return name;
  return 'Other';
}

const TYPE_PATTERNS = [
  ['Followers', /follows?|followers?|subs?(cribers?)?/i],
  ['Likes', /likes?/i],
  ['Views', /views?|plays?|watch(?:time)?/i],
  ['Comments', /comments?/i],
  ['Saves', /saves?/i],
  ['Shares', /shares?/i],
  ['Impressions', /impressions?/i],
  ['Votes', /votes?/i],
  ['Members', /members?/i],
  ['Reposts', /reposts?/i],
  ['Story', /story|stories/i],
  ['Traffic', /traffic|visits?/i],
];
function getBaseType(name){
  for(const [label,rx] of TYPE_PATTERNS) if (rx.test(name)) return label;
  return 'Other';
}

/* ---------- TAGS / UTILS ---------- */
function makeTags(name){
  const n = String(name||'');
  const tags = [];
  const add = (txt, kind='gray') => tags.push({text:txt,kind});
  if (/fast|instant/i.test(n)) add('Fast','green');
  if (/cheap|cheapest/i.test(n)) add('Cheapest','amber');
  if (/real|hq|quality/i.test(n)) add('HQ','purple');
  if (/refill/i.test(n)) add('Refill','green');
  if (/drip/i.test(n)) add('Dripfeed','purple');
  if (/old accounts?/i.test(n)) add('Old Accounts','gray');
  if (/new accounts?/i.test(n)) add('New Accounts','gray');
  return tags;
}
function escapeHtml(x){ return x?.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))||'' }
function countServices(map){ let n=0; for(const [,arr] of map) n+=arr.length; return n; }

/* ---------- LOAD + RENDER ---------- */
async function load(){
  const q = encodeURIComponent(elQ.value||'');
  const cat = encodeURIComponent(elCat.value||'');
  const url = `${API}?action=services${q?`&q=${q}`:''}${cat?`&category=${cat}`:''}`;
  const res = await fetch(url);
  let data;
  try{ data = await res.json(); } catch { showErr('Failed to parse services'); return; }
  if(!Array.isArray(data)){ showErr(data?.error||'Failed to load services'); return; }

  // group by platform → base type
  const byPlat = new Map();
  for(const s of data){
    const plat = detectPlatform(`${s.category} ${s.name}`);
    const type = getBaseType(s.name);
    if(!byPlat.has(plat)) byPlat.set(plat, new Map());
    const m = byPlat.get(plat);
    if(!m.has(type)) m.set(type, []);
    // attach normalized per-1k for sorting/display
    s.price_per_1k = normalizePrice(s);
    m.get(type).push(s);
  }

  // fill platform dropdown once
  if(!elCat.dataset.filled){
    const plats = [...byPlat.keys()].sort();
    for(const p of plats){ const o=document.createElement('option'); o.value=p; o.textContent=p; elCat.appendChild(o); }
    elCat.dataset.filled='1';
  }

  // render
  elWrap.innerHTML = '';
  const want = elCat.value;
  for(const [plat, byType] of byPlat){
    if(want && plat!==want) continue;
    const color = PLATFORM_COLORS[plat] || PLATFORM_COLORS.Other;

    const sec = document.createElement('section');
    sec.className='section';
    sec.style.setProperty('--plat', color);
    sec.innerHTML = `
      <div class="head">
        <div class="row">
          <span class="chip blue s">${plat}</span>
          <span class="chip gray s">${countServices(byType)} services</span>
        </div>
        <div class="muted">Toggle</div>
      </div>
      <div class="body"><div class="grid"></div></div>
    `;
    const head = sec.querySelector('.head');
    head.addEventListener('click', ()=>sec.classList.toggle('open'));

    const grid = sec.querySelector('.grid');
    for(const [type, list] of byType){
      // sort by normalized price
      list.sort((a,b)=>a.price_per_1k - b.price_per_1k);
      const cheapest = list[0];

      const card = document.createElement('div');
      card.className='card';
      card.innerHTML = `
        <h3><span class="brand">[DropSource]</span> <span class="muted">—</span> <span style="color:#cdd7ff">${escapeHtml(type)}</span></h3>
        <div class="muted">${escapeHtml(plat)}</div>
        <div class="row">
          <span class="chip s gray">Min ${cheapest.min}</span>
          <span class="chip s gray">Max ${cheapest.max}</span>
          ${cheapest.dripfeed?'<span class="chip s purple">Dripfeed</span>':''}
          ${cheapest.refill?'<span class="chip s green">Refill</span>':''}
        </div>
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="price">$${cheapest.price_per_1k.toFixed(2)} <span class="muted">/ 1k</span></div>
          <div class="row">
            <button class="btn" data-order>Order</button>
            <button class="btn" data-expand>View variants</button>
          </div>
        </div>
      `;

      // variants
      const det = document.createElement('details');
      det.style.marginTop='6px';
      det.innerHTML = `<summary>Variants (${list.length})</summary><div></div>`;
      const vWrap = det.querySelector('div');
      for(const svc of list){
        const tags = makeTags(svc.name);
        const row = document.createElement('div');
        row.className='variant';
        row.innerHTML = `
          <div class="row">
            ${tags.map(t=>`<span class="chip s ${t.kind}">${escapeHtml(t.text)}</span>`).join('')}
          </div>
          <div class="row">
            <div class="price" style="font-size:13px">$${normalizePrice(svc).toFixed(2)} <span class="muted">/1k</span></div>
            <button class="btn" data-order-variant="${svc.id}">Order</button>
          </div>`;
        vWrap.appendChild(row);
      }
      card.appendChild(det);

      // ====== ORDER HANDLERS (custom amount prompt) ======
      card.querySelector('[data-expand]').onclick = () => det.open = !det.open;

      function orderWithCustomAmount(variants, chosenId){
        const link = prompt('Paste the target link (post/profile URL):');
        if (!link) return;

        const qty = Number(prompt('Quantity (any number you want):'));
        if (!Number.isFinite(qty) || qty <= 0) { alert('Invalid quantity'); return; }

        // If user clicked a specific variant "Order" button:
        if (chosenId){
          const svc = variants.find(v => v.id == chosenId);
          if (!svc) return alert('Service not found');
          if (qty < Number(svc.min) || qty > Number(svc.max)) {
            return alert(`This variant supports ${svc.min}–${svc.max}. Try a different amount or use "Order" on the card to auto-pick.`);
          }
          placeOrder(svc.id, link, qty).then(handleOrderResponse).catch(handleOrderError);
          return;
        }

        // Otherwise: pick the cheapest eligible variant for that qty
        const eligible = variants.filter(v => Number(v.min) <= qty && qty <= Number(v.max));
        if (eligible.length === 0) {
          const cheapest = [...variants].sort((a,b)=>normalizePrice(a)-normalizePrice(b))[0];
          const minAllowed = Number(cheapest.min);
          if (qty < minAllowed) {
            if (confirm(`Providers require at least ${minAllowed}. Order ${minAllowed} instead?`)) {
              placeOrder(cheapest.id, link, minAllowed).then(handleOrderResponse).catch(handleOrderError);
            }
            return;
          }
          alert('No variant supports that amount. Try another quantity.');
          return;
        }
        const chosen = eligible.sort((a,b)=>normalizePrice(a)-normalizePrice(b))[0];
        placeOrder(chosen.id, link, qty).then(handleOrderResponse).catch(handleOrderError);
      }

      function handleOrderResponse(r){
        if (r?.error) alert('Error: ' + r.error);
        else alert('Order placed! ID: ' + r.order);
      }
      function handleOrderError(e){ alert('Network issue: ' + e.message); }

      // big "Order" button -> custom amount, auto-pick cheapest eligible
      card.querySelector('[data-order]').onclick = () => orderWithCustomAmount(list);

      // per-variant "Order" -> custom amount but must be within that variant's min/max
      card.querySelectorAll('[data-order-variant]').forEach(btn=>{
        btn.onclick = () => orderWithCustomAmount(list, btn.getAttribute('data-order-variant'));
      });

      grid.appendChild(card);
    }

    elWrap.appendChild(sec);
  }
}

/* ---------- API CALLS ---------- */
async function placeOrder(serviceId, link, quantity, runs, interval){
  const res = await fetch(API, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ action:'add', service: serviceId, link, quantity, runs, interval })
  });
  return res.json();
}

load();
</script>
</body>
</html>