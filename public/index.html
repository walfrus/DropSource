<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DropSource — SMM</title>
  <style>
    :root{
      --bg:#0b0b0f; --card:#15161a; --txt:#e8ecf1; --muted:#a6acb3;
      --brand:#59a0ff; --stroke:#24262c; --chip:#1c2028;
      --accent:#7aa9ff; /* softer than brand for hover/borders */
      /* subtle tag colors (low saturation / alpha) */
      --c-blue:  hsla(210,90%,60%,.16); --t-blue:#a3c5ff;
      --c-pink:  hsla(330,80%,65%,.16); --t-pink:#f3b3d6;
      --c-green: hsla(150,55%,55%,.16); --t-green:#b9f1d6;
      --c-amber: hsla(40, 85%,60%,.16); --t-amber:#f4d3a5;
      --c-purple:hsla(265,60%,65%,.16); --t-purple:#d4c0ff;
      --c-gray:  hsla(220,12%,60%,.14); --t-gray:#cbd3db;
      --shadow: 0 6px 24px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto}
    header{padding:16px;display:flex;gap:12px;align-items:center;justify-content:space-between;border-bottom:1px solid var(--stroke);position:sticky;top:0;background:linear-gradient(180deg,rgba(11,11,15,.95),rgba(11,11,15,.85));backdrop-filter:saturate(120%) blur(6px);z-index:10}
    .brand{color:var(--brand);font-weight:700}
    .brand, .brand *{color:var(--brand)!important}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    input,select,button{background:#11131a;border:1px solid var(--stroke);color:var(--txt);padding:10px 12px;border-radius:10px}
    button{cursor:pointer}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .chip{padding:3px 8px;border-radius:999px;background:var(--chip);color:#b9c2cc;font-size:12px;border:1px solid rgba(255,255,255,.04)}
    .chip.s{font-size:11px;padding:2px 6px}
    .chip.blue{background:var(--c-blue);color:var(--t-blue);border-color:rgba(122,169,255,.18)}
    .chip.pink{background:var(--c-pink);color:var(--t-pink);border-color:rgba(243,179,214,.18)}
    .chip.green{background:var(--c-green);color:var(--t-green);border-color:rgba(185,241,214,.18)}
    .chip.amber{background:var(--c-amber);color:var(--t-amber);border-color:rgba(244,211,165,.18)}
    .chip.purple{background:var(--c-purple);color:var(--t-purple);border-color:rgba(212,192,255,.18)}
    .chip.gray{background:var(--c-gray);color:var(--t-gray);border-color:rgba(203,211,219,.16)}
    .section{border:1px solid var(--stroke);border-radius:14px;overflow:hidden;margin-bottom:14px;box-shadow:var(--shadow)}
    .section > .head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:#111218;border-bottom:1px solid var(--stroke);cursor:pointer}
    .section > .body{padding:14px;display:none}
    .section.open > .body{display:block}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:12px}
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:14px;display:flex;flex-direction:column;gap:10px}
    .card h3{margin:0;font-size:15px;line-height:1.35}
    .spacer{flex:1}
    .price{font-weight:700}
    .btn{padding:8px 10px;border-radius:10px;background:#10131a;border:1px solid var(--stroke)}
    .btn:hover{border-color:var(--accent)}
    .footer{opacity:.7;font-size:12px;padding:18px;text-align:center}
    .toggle{font-size:12px;color:var(--muted);cursor:pointer}
    details{background:#12141b;border:1px dashed rgba(255,255,255,.06);border-radius:12px}
    details>summary{list-style:none;padding:8px 10px;cursor:pointer;color:var(--muted)}
    details[open]>summary{color:#d6deea}
    .variant{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-top:1px solid rgba(255,255,255,.04)}
    .toolbar{display:flex;gap:8px;align-items:center}
    .toolbar .btn{padding:6px 10px}
  </style>
</head>
<body>
  <header>
    <div><strong class="brand">DropSource</strong> · Boosts</div>
    <div class="row">
      <input id="q" placeholder="Search services…" />
      <select id="cat"><option value="">All categories</option></select>
      <div class="toolbar">
        <button id="expandAll" class="btn">Expand all</button>
        <button id="collapseAll" class="btn">Collapse all</button>
        <button id="reload" class="btn">Reload</button>
      </div>
    </div>
  </header>

  <div class="container" id="wrap"></div>

  <div class="footer">Powered by <span class="brand">DropSource</span> • your growth plug, but like… responsibly ✌️</div>

<script>
const API = '/api/smm';
const elQ = document.getElementById('q');
const elCat = document.getElementById('cat');
const elWrap = document.getElementById('wrap');
const elReload = document.getElementById('reload');
const elExpandAll = document.getElementById('expandAll');
const elCollapseAll = document.getElementById('collapseAll');

function showErr(msg){ console.error(msg); alert(msg); }

// ---- base-type detector (what we show as the “card” for a category)
const TYPE_PATTERNS = [
  ['Followers', /follows?|followers?|subs?(cribers?)?/i],
  ['Likes', /likes?/i],
  ['Views', /views?|plays?|watch(?:time)?/i],
  ['Comments', /comments?/i],
  ['Saves', /saves?/i],
  ['Shares', /shares?/i],
  ['Impressions', /impressions?/i],
  ['Votes', /votes?/i],
  ['Members', /members?/i],
  ['Reposts', /reposts?/i],
  ['Story', /story|stories/i],
  ['Traffic', /traffic|visits?/i],
];

function getBaseType(name) {
  for (const [label, rx] of TYPE_PATTERNS) if (rx.test(name)) return label;
  return 'Other';
}

function isVariantTag(word){
  return /fast|cheap|cheapest|refill|drip|real|hq|instant|[0-9]+d|brazil|usa|ind|arab|mex|tier|quality|old accounts?|new|cancel|enable|flag/i.test(word);
}

// brand scrub + single prefix
function brandLabel(rawName){
  const clean = String(rawName || '').replace(/smmgoal/gi,'DropSource').replace(/\[?DropSource\]?\s*[—-]\s*/i,'').trim();
  return `[DropSource] — ${clean}`;
}

async function fetchServices() {
  const q = encodeURIComponent(elQ.value || '');
  const cat = encodeURIComponent(elCat.value || '');
  const url = `${API}?action=services${q ? '&q='+q : ''}${cat ? '&category='+cat : ''}`;
  const res = await fetch(url);
  let data;
  try { data = await res.json(); } catch { showErr('Failed to parse services'); return; }
  if (!Array.isArray(data)) { showErr(data?.error || 'Failed to load services'); return; }
  render(data);
  // fill categories once
  if (!elCat.dataset.filled) {
    const cats = [...new Set(data.map(s => s.category).filter(Boolean))].sort();
    for (const c of cats) {
      const opt = document.createElement('option'); opt.value = c; opt.textContent = c; elCat.appendChild(opt);
    }
    elCat.dataset.filled = '1';
  }
}

function render(services){
  // group -> category -> baseType
  const byCat = new Map();
  for (const s of services){
    const cat = s.category || 'Other';
    const type = getBaseType(s.name);
    if (!byCat.has(cat)) byCat.set(cat, new Map());
    const m = byCat.get(cat);
    if (!m.has(type)) m.set(type, []);
    m.get(type).push(s);
  }

  // build UI
  elWrap.innerHTML = '';
  for (const [cat, byType] of byCat){
    // section
    const sec = document.createElement('section');
    sec.className = 'section';
    sec.innerHTML = `
      <div class="head">
        <div class="row">
          <span class="chip blue s">${cat}</span>
          <span class="chip gray s">${countServices(byType)} services</span>
        </div>
        <div class="toggle">Toggle</div>
      </div>
      <div class="body"><div class="grid"></div></div>`;
    const head = sec.querySelector('.head');
    const grid = sec.querySelector('.grid');
    head.addEventListener('click', ()=>sec.classList.toggle('open'));

    // cards for each base type (show cheapest summary)
    for (const [type, list] of byType){
      // sort by price
      list.sort((a,b)=>a.price_per_1k - b.price_per_1k);
      const cheapest = list[0];
      const card = document.createElement('div');
      card.className = 'card';
      const nameLine = brandLabel(`${type}`);
      card.innerHTML = `
        <h3><span class="brand">[DropSource]</span> <span class="muted">—</span> <span style="color:#cdd7ff">${escapeHtml(type)}</span></h3>
        <div class="muted">${escapeHtml(cat)}</div>
        <div class="row">
          <span class="chip s gray">Min ${cheapest.min}</span>
          <span class="chip s gray">Max ${cheapest.max}</span>
          ${cheapest.dripfeed ? '<span class="chip s purple">Dripfeed</span>' : ''}
          ${cheapest.refill ? '<span class="chip s green">Refill</span>' : ''}
        </div>
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="price">$${cheapest.price_per_1k.toFixed(2)} <span class="muted">/ 1k</span></div>
          <div class="row">
            <button class="btn" data-order="${cheapest.id}">Order cheapest</button>
            <button class="btn" data-expand>View variants</button>
          </div>
        </div>
      `;
      // variants section
      const det = document.createElement('details');
      det.style.marginTop = '6px';
      det.innerHTML = `<summary>Variants (${list.length})</summary><div></div>`;
      const vWrap = det.querySelector('div');
      for (const svc of list){
        // build soft tags from name
        const tags = makeTags(svc.name);
        const row = document.createElement('div');
        row.className = 'variant';
        row.innerHTML = `
          <div class="row">
            ${tags.map(t => `<span class="chip s ${t.kind}">${escapeHtml(t.text)}</span>`).join('')}
          </div>
          <div class="row">
            <div class="price" style="font-size:13px">$${svc.price_per_1k.toFixed(2)} <span class="muted">/1k</span></div>
            <button class="btn" data-order="${svc.id}">Order</button>
          </div>`;
        vWrap.appendChild(row);
      }
      card.appendChild(det);

      // handlers
      card.querySelector('[data-expand]').addEventListener('click', ()=>det.open = !det.open);
      card.querySelectorAll('[data-order]').forEach(btn=>{
        btn.addEventListener('click', ()=> openOrder(list.find(x=>x.id==btn.dataset.order)));
      });

      grid.appendChild(card);
    }

    elWrap.appendChild(sec);
  }
}

function countServices(map){
  let n=0; for (const [,arr] of map) n+=arr.length; return n;
}

function makeTags(name){
  const n = String(name||'');
  const tags = [];
  const add = (txt, kind='gray')=>tags.push({text:txt,kind});
  // soft extraction
  if (/fast|instant/i.test(n)) add('Fast','green');
  if (/cheap|cheapest/i.test(n)) add('Cheapest','amber');
  if (/real|hq|quality/i.test(n)) add('HQ','purple');
  if (/refill/i.test(n)) add('Refill','green');
  if (/drip/i.test(n)) add('Dripfeed','purple');
  // region hints
  const regions=[['Brazil','amber'],['USA','blue'],['UK','blue'],['India','pink'],['Arab','pink'],['Mexico','amber']];
  for (const [r,c] of regions) if (new RegExp(r,'i').test(n)) add(r,c);
  // account hints
  if (/old accounts?/i.test(n)) add('Old Accounts','gray');
  if (/new accounts?/i.test(n)) add('New Accounts','gray');
  return tags;
}

function escapeHtml(x){return x?.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) || ''}

async function placeOrder(serviceId, link, quantity, runs, interval) {
  const res = await fetch(API, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ action:'add', service: serviceId, link, quantity, runs, interval })
  });
  return res.json();
}

function openOrder(svc){
  const link = prompt('Paste the target link (post/profile URL):');
  if(!link) return;
  const qty = Number(prompt(`Quantity (min ${svc.min}, max ${svc.max})`));
  if(!qty || qty < svc.min || qty > svc.max){ alert('Quantity out of range'); return; }
  placeOrder(svc.id, link, qty).then(r=>{
    if(r.error) alert('Error: '+r.error);
    else alert('Order placed! ID: '+r.order);
  }).catch(e=>alert('Network issue: '+e.message));
}

// controls
elQ.addEventListener('input', () => fetchServices());
elCat.addEventListener('change', () => fetchServices());
elReload.addEventListener('click', () => fetchServices());
elExpandAll.addEventListener('click', () => document.querySelectorAll('.section').forEach(s=>s.classList.add('open')));
elCollapseAll.addEventListener('click', () => document.querySelectorAll('.section').forEach(s=>s.classList.remove('open')));

// initial load
fetchServices();
</script>
</body>
</html>