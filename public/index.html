<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DropSource — Boosts</title>
  <style>
    :root{--bg:#0b0f16;--fg:#e6edf7;--muted:#9fb3c8;--chip:#1a2230;--brand:#8aa6ff;--card:#0f1520;--line:#1b2434;--btn:#1b2a45;--btn-fg:#e6edf7}
    *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.6 system-ui,Segoe UI,Helvetica,Arial,sans-serif}
    header{position:sticky;top:0;background:#0d1421;border-bottom:1px solid var(--line);padding:10px 12px;z-index:5}
    header .row{display:flex;align-items:center;gap:10px;max-width:1200px;margin:0 auto}
    .brand{color:var(--brand);font-weight:800}
    #toolbar{display:flex;gap:8px;max-width:1200px;margin:12px auto 0}
    input,select,button{background:#0e1726;color:var(--fg);border:1px solid var(--line);border-radius:8px;padding:10px 12px}
    input,select{flex:1;min-width:180px}
    button{background:var(--btn);color:var(--btn-fg);cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;max-width:1200px;margin:12px auto}
    /* Masonry layout for service cards to prevent sibling cards expanding */
    .grid.cards{
      display:block;              /* use CSS columns */
      column-width:320px;         /* target column width */
      column-gap:12px;
    }
    .grid.cards .card{
      display:inline-block;
      width:100%;
      break-inside:avoid;         /* avoid column breaks inside cards */
    }
    /* Fallback for browsers that keep grid semantics */
    .grid{ align-items:start; }
    .card{
  background:var(--card);
  border:1px solid var(--line);
  border-radius:12px;
  padding:12px;
  transition:border-color .15s ease, box-shadow .15s ease, transform .15s ease;
}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .chip{background:var(--chip);border:1px solid var(--line);padding:3px 8px;border-radius:999px}
    .chip.s{font-size:12px}
    .chip.green{background:#0d2a1a;border-color:#194d33}
    .chip.purple{background:#1d1230;border-color:#3d2b7a}
    .chip.blue{background:#0f2238;border-color:#224e8a}
    .chip.gray{background:#121826;border-color:#1b2434}
    .chip.amber{background:#2a2112;border-color:#5a3d12}

/* Hover accents using the platform color stored in --plat */
.card:hover{
  border-color:var(--plat, var(--brand));
  box-shadow:0 0 0 1px var(--plat, var(--brand)) inset, 0 10px 30px rgba(0,0,0,.25)
}
.card.cat:hover{ transform:translateY(-1px); }
.section .head:hover{ background:linear-gradient(90deg,var(--plat, var(--line)), transparent); }

/* Variant rows fit & layout */
.variant{
  display:flex;justify-content:space-between;align-items:flex-start;
  gap:10px;padding:8px;border:1px solid var(--line);border-radius:10px;
  margin:6px 0;background:#0c1422
}
.variant .row:first-child{flex:1;min-width:0}
.variant .row:first-child > div{
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%
}
.variant .price{white-space:nowrap}
.variants{max-height:60vh;overflow:auto;padding-right:4px}

details summary{list-style:none}
details[open] summary{opacity:.9}
    .price{font-weight:700}
    .section{border:1px solid var(--line);border-radius:16px;margin:12px auto;max-width:1200px;overflow:hidden}
    .section .head{display:flex;justify-content:space-between;padding:10px 12px;background:linear-gradient(90deg,var(--line),transparent);cursor:pointer}
    .section .body{display:none;padding:8px}
    .section.open .body{display:block}
    details{background:#0a1220;border:1px solid var(--line);border-radius:10px;padding:6px}
    summary{cursor:pointer;user-select:none}
    #wrap .loading{max-width:1200px;margin:30px auto;padding:16px;border:1px dashed var(--line);border-radius:12px}
    #errorOverlay{position:fixed;inset:0;background:rgba(8,12,18,.92);color:#fff;display:none;align-items:center;justify-content:center;padding:24px;z-index:99}
    #errorOverlay pre{max-width:1000px;white-space:pre-wrap;word-break:break-word;background:#111a2a;border:1px solid #2b3b55;padding:16px;border-radius:12px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <div class="row">
      <div class="brand">DropSource</div>
      <div class="muted">Boosts marketplace</div>
      <div id="authbar" class="row" style="margin-left:auto;gap:8px">
        <button id="loginBtn" class="btn">Sign in</button>
        <button id="logoutBtn" class="btn" style="display:none">Sign out</button>
      </div>
    </div>
  </header>

  <div id="toolbar">
    <input id="q" placeholder="Search services…" />
    <select id="cat"><option value="">All platforms</option></select>
    <button id="reload">Reload</button>
    <button id="expandAll">Expand all</button>
    <button id="collapseAll">Collapse all</button>
  </div>

  <div id="wrap"><div class="loading">Loading services…</div></div>
  <div id="errorOverlay"><pre id="errorText"></pre></div>

  <script>
    // @ts-nocheck
    /* eslint-disable */
    // Inline DOM builder uses long template strings intentionally.
    (function(){
      // hard fail reporter so a white page is impossible
      function showFatal(err){
        console.error(err);
        const o=document.getElementById('errorOverlay');
        const t=document.getElementById('errorText');
        if(t){ t.textContent = (err && (err.stack||err.message||String(err))) || 'Unknown error'; }
        if(o){ o.style.display='flex'; }
      }
      window.addEventListener('error', e=>showFatal(e.error||e.message||e));
      window.addEventListener('unhandledrejection', e=>showFatal(e.reason||e));

      try{
        // --- config & dom refs -------------------------------------------------------
        const API = '/api/smm';
        const elQ = document.getElementById('q');
        const elCat = document.getElementById('cat');
        const elWrap = document.getElementById('wrap');
        document.getElementById('reload').onclick = load;
        document.getElementById('expandAll').onclick = ()=>document.querySelectorAll('.section').forEach(s=>s.classList.add('open'));
        document.getElementById('collapseAll').onclick = ()=>document.querySelectorAll('.section').forEach(s=>s.classList.remove('open'));
        elQ.oninput = load;

        // --- Supabase Auth (Google + Email/Magic) -----------------------------------
        const SUPABASE_URL = window.SUPABASE_URL || 'https://oyibixfoiwizpphuimkl.supabase.co';
        const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95aWJpeGZvaXdpenBwaHVpbWtsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwOTMzNTAsImV4cCI6MjA3MTY2OTM1MH0.MddtDHuzo9PPGJaZWG9Ny0UAuUIYUKzT2Q27OpK66Rg';
        const sb = (window.supabase && SUPABASE_URL !== 'https://oyibixfoiwizpphuimkl.supabase.co')
          ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
          : null;

        const elLogin = document.getElementById('loginBtn');
        const elLogout = document.getElementById('logoutBtn');

        async function refreshAuthUI(){
          if(!sb || !elLogin || !elLogout){ return; }
          const { data:{ session } } = await sb.auth.getSession();
          elLogin.style.display = session ? 'none' : '';
          elLogout.style.display = session ? '' : 'none';
        }
        async function signIn(){
          if(!sb) return;
          // Use Google OAuth; Supabase will redirect back to the current page.
          await sb.auth.signInWithOAuth({ provider:'google', options:{ redirectTo: location.href } });
        }
        async function signOut(){
          if(!sb) return;
          await sb.auth.signOut();
          await refreshAuthUI();
        }
        async function ensureAuth(){
          if(!sb) return true; // allow while not configured
          const { data:{ session } } = await sb.auth.getSession();
          if(session) return true;
          await signIn();
          return false;
        }
        if(elLogin) elLogin.onclick = signIn;
        if(elLogout) elLogout.onclick = signOut;
        if(sb) sb.auth.onAuthStateChange(()=>refreshAuthUI());
        refreshAuthUI();
        // hide and disable the platform/source selector per requirements
        if (elCat){ elCat.style.display = 'none'; elCat.onchange = null; }
        // keep only one <details> open on the whole page
        document.addEventListener('toggle', (ev) => {
          const det = ev.target;
          if (det && det.tagName === 'DETAILS' && det.open) {
            document.querySelectorAll('details[open]').forEach(d => { if (d !== det) d.open = false; });
          }
        }, true);

        function showErr(m){ console.error(m); const box=document.createElement('div'); box.className='loading'; box.textContent=m; elWrap.replaceChildren(box);} 
        // --- platform meta -----------------------------------------------------------
        function normKey(s){
          return String(s||'').toLowerCase().replace(/[^\p{L}\p{N}. ]+/gu,' ').trim().replace(/\s+/g,' ');
        }

        const ALLOWED_PLAT_LABELS = new Map([
          ['instagram','Instagram'],
          ['threads','Threads'],
          ['youtube','YouTube'],
          ['tiktok','TikTok'],
          ['facebook','Facebook'],
          ['twitter','X (Twitter)'],
          ['x','X (Twitter)'],
          ['x (twitter)','X (Twitter)'],
          ['twitch','Twitch'],
          ['discord','Discord'],
          ['telegram','Telegram'],
          ['snapchat','Snapchat'],
          ['soundcloud','SoundCloud'],
          ['spotify','Spotify'],
          ['shazam','Shazam'],
          ['pinterest','Pinterest'],
          ['clubhouse','Clubhouse'],
          ['imdb','IMDb'],
          ['linkedin','LinkedIn'],
          ['datpiff','DatPiff'],
          ['vimeo','Vimeo'],
          ['reverbnation','ReverbNation'],
          ['vk','VK'],
          ['tumblr','Tumblr'],
          ['mixcloud','Mixcloud'],
          ['podcast','Podcast (Apple Music)'],
          ['podcast (apple music)','Podcast (Apple Music)'],
          ['google business reviews','Google Business Reviews'],
          ['tidal','Tidal'],
          ['ok.ru','OK.ru'],
          ['okru','OK.ru'],
          ['quora','Quora'],
          ['reddit','Reddit'],
          ['coub','Coub'],
          ['dailymotion','Dailymotion'],
          ['rumble','Rumble'],
          ['audiomack','Audiomack'],
          ['webtraffic','WebTraffic'],
          ['web traffic','WebTraffic'],
          ['distribution','Distribution'],
          ['chenhosting','ChenHosting'],
          ['whatsapp','WhatsApp'],
          ['kick','Kick'],
          ['vpn','VPN'],
        ]);

        const PLATFORM_COLORS = {
          'Instagram':'#E1306C',
          'Telegram':'#2CA5E0',
          'Twitter':'#1DA1F2',
          'X (Twitter)':'#000000',
          'TikTok':'#FFFFFF',
          'Facebook':'#1877F2',
          'YouTube':'#FF0000',
          'Spotify':'#1DB954',
          'SoundCloud':'#FF5500',
          'Threads':'#000000',
          'VK':'#4C75A3',
          'Twitch':'#9146FF',
          'Reddit':'#FF4500',
          'Pinterest':'#E60023',
          'Podcast (Apple Music)':'#E1306C',
          'LinkedIn':'#0A66C2',
          'Snapchat':'#FFFC00',
          'Discord':'#5865F2',
          'Shazam':'#0088FF',
          'Vimeo':'#1AB7EA',
          'Quora':'#B92B27',
          'Mixcloud':'#6C63FF',
          'OK.ru':'#F4731C',
          'Audiomack':'#FFA200',
          'Dailymotion':'#0066DC',
          'ReverbNation':'#FF69B4',
          'Tumblr':'#374459',
          'WhatsApp':'#25D366',
          'WebTraffic':'#59a0ff',
          'Distribution':'#59a0ff',
          'ChenHosting':'#59a0ff',
          'Kick':'#59a0ff',
          'VPN':'#59a0ff',
          'Other':'#59a0ff',
        };

        function detectPlatform(str=''){
          const s = String(str).toLowerCase();
          const map = [
            ['Instagram',/(^|\b)(instagram|ig)\b/],
            ['Telegram',/(^|\b)(telegram|tg)\b/],
            ['Twitter',/(^|\b)twitter\b/],
            ['X',/(^|\b)x\b(?![a-z])/],
            ['TikTok',/(^|\b)(tiktok|tt)\b/],
            ['Facebook',/(^|\b)(facebook|fb)\b/],
            ['YouTube',/(^|\b)(youtube|yt|shorts)\b/],
            ['Spotify',/spotify/],
            ['SoundCloud',/soundcloud/],
            ['Threads',/(^|\b)threads?\b/],
            ['VK',/(^|\b)vk\b|vkontakte/],
            ['Twitch',/twitch/],
            ['Reddit',/reddit/],
            ['Pinterest',/pinterest/],
            ['LinkedIn',/(^|\b)linkedin\b/],
            ['Snapchat',/snapchat/],
            ['Discord',/discord/],
            ['Shazam',/shazam/],
            ['Vimeo',/vimeo/],
            ['Quora',/quora/],
            ['Mixcloud',/mixcloud/],
            ['OK.ru',/ok\.?ru|(^|\b)ok\b/],
            ['Audiomack',/audiomack/],
            ['Dailymotion',/dailymotion/],
            ['Reverbnation',/reverbnation/],
            ['Tumblr',/tumblr/],
            ['WhatsApp',/whatsapp/],
            ['Website',/\bwebsite\b|web ?traffic|seo|site traffic|webtraffic/],
            ['Mobile',/\bmobile\b|app installs?/],
            ['Crypto',/crypto|bitcoin|\bbtc\b|\beth\b|ethereum/],
            ['GeoTarget',/\bgeo|country|region|target/],
            ['GoogleReviews',/google ?reviews?/],
            ['OwnWebsite',/ownwebsite|own website/],
            ['MaskedTraffic',/masked ?traffic/],
            ['Podcast',/podcast/],
            ['MassDM',/mass ?dm/],
            ['Exchange',/exchange/],
          ];
          for (const [name,rx] of map) if (rx.test(s)) return name;
          return 'Other';
        }

        const TYPE_PATTERNS = [
          ['Followers', /follows?|followers?|subs?(cribers?)?/i],
          ['Likes', /likes?/i],
          ['Views', /views?|plays?|watch(?: ?time)?/i],
          ['Comments', /comments?/i],
          ['Saves', /saves?/i],
          ['Shares', /shares?|reposts?/i],
          ['Impressions', /impressions?/i],
          ['Votes', /votes?|poll/i],
          ['Members', /members?/i],
          ['Mentions', /mentions?/i],
          ['Story', /story|stories/i],
          ['Live', /live\b/i],
          ['Traffic', /traffic|visits?/i],
          ['Other', /.*/]
        ];
        function getBaseType(name){ for(const [label,rx] of TYPE_PATTERNS) if (rx.test(name)) return label; return 'Other'; }

        function slugify(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
        function formatK(n){ n = Number(n||0); if(n>=1_000_000) return (n/1_000_000).toFixed(n%1_000_000?1:0)+'M'; if(n>=1_000) return (n/1_000).toFixed(n%1_000?1:0)+'K'; return String(n); }
        function escapeHtml(x){ return x?.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]))||'' }
        function stripEmojis(str){ return String(str||'').replace(/[\u{1F300}-\u{1FAFF}\u{2600}-\u{27BF}\u{1F1E6}-\u{1F1FF}]/gu,''); }
        function baseLabel(name){ const s = stripEmojis(String(name||'')); const cut = s.split(/[\[|]/)[0]; return cut.replace(/smmgoal/ig,'').replace(/\s+/g,' ').trim(); }

        function extractMeta(name){
          const s = String(name||'');
          const chips = [];
          const add = (t,kind='gray')=>chips.push({text:t,kind});
          const r1 = s.match(/(\d{1,3})\s*Days?\s*Refill/i); if(r1) add(`Refill ${r1[1]}d`,'green');
          const r2 = s.match(/\bR(B)?(\d{1,3})\b/i); if(r2) add(`Refill ${r2[2]}d`,'green');
          if(/no\s*refill|non\s*refill|no\s*support/i.test(s)) add('No refill','amber');
          if(/instant|0-?\s*\d+\s*min/i.test(s)) add('Instant','green');
          const spd = s.match(/speed[:\s]*(\d+[kKmM]?)[^\w]*/i); if(spd) add(`Speed ${spd[1]}/d`,'blue');
          if(/no\s*drop|non\s*drop/i.test(s)) add('No drop','purple');
          if(/hq|high\s*quality|premium/i.test(s)) add('HQ','purple');
          if(/cheap|cheapest/i.test(s)) add('Cheapest','amber');
          const geos = ['USA','US','UK','Germany','France','Italy','Spain','Brazil','Korea','Japan','India','Turkey','Canada'];
          for(const g of geos){ const rx = new RegExp(`\\b${g}\\b`,'i'); if(rx.test(s)){ add(g.toUpperCase(),'blue'); break; } }
          return chips;
        }

        function summarizeVariant(svc, plat, type){
          let label = baseLabel(svc.name);
          // fallback if the base label collapses to something generic
          if (!label || /^(instagram|tiktok|facebook|youtube|twitter|x|threads|views?|likes?|followers?)$/i.test(label)) {
            label = type || 'Variant';
          }
          const chips = extractMeta(svc.name);
          chips.unshift({text:`Min ${formatK(svc.min)}`,kind:'gray'});
          chips.unshift({text:`Max ${formatK(svc.max)}`,kind:'gray'});
          return {label, chips};
        }

        // -------- unified data source (CSV only) ----------
        async function fetchServices() {
          // CSV‑only mode per user preference
          return await fetchCsvServices();
        }

        async function fetchApiServices() {
          const q = encodeURIComponent(elQ.value||'');
          const cat = encodeURIComponent(elCat.value||'');
          const url = `${API}?action=services${q?`&q=${q}`:''}${cat?`&category=${cat}`:''}`;
          const res = await fetch(url);
          let data = [];
          try { data = await res.json(); } catch(e) { return []; }
          if (!Array.isArray(data)) return [];
          // normalize field names
          return data.map(s => ({
            id: s.id,
            name: s.name,
            min: Number(s.min||0),
            max: Number(s.max||0),
            price_per_1k: Number(s.price_per_1k||0),
            category: s.category||''
          }));
        }

        // ---- CSV helpers (namespaced to avoid collisions) ----
        // Preprocess CSV that includes category markers like "*//Instagram"
        // Converts markers into an extra "__cat__" column appended to each data row.
        function normalizeCsvWithMarkers(csvText) {
          const lines = csvText.split(/\r?\n/);
          let currentCat = "";
          const out = [];
          for (let raw of lines) {
            if (raw == null) continue;
            const line = raw.trim();
            if (!line) continue; // skip blank spacer lines
            if (line.startsWith("*//")) {
              currentCat = line.replace(/^\*\/\/\s*/, "").trim();
              continue;
            }
            // header: extend with category column
            if (line.startsWith(`"name","rate_per_1k_usd","min","max"`)) {
              out.push(`${line},"__cat__"`);
              continue;
            }
            // data row (quoted)
            if (line.startsWith(`"`)) {
              out.push(`${line},"${currentCat}"`);
              continue;
            }
            // ignore any other non-data lines
          }
          return out.join("\n");
        }
        async function fetchCsvServices() {
          const candidates = [
            '/smmgoals.services.csv',              // public root (recommended)
            '/public/smmgoals.services.csv',       // some setups expose /public prefix
            './smmgoals.services.csv'              // relative to current page
          ];
          let text = '';
          for (const u of candidates) {
            try {
              const res = await fetch(u + '?v=' + Date.now(), { cache: 'no-store' });
              if (res.ok) { text = await res.text(); break; }
            } catch (_) { /* continue */ }
          }
          if (!text) {
            console.warn('CSV not found at any path; continuing without CSV. Move smmgoals.services.csv into /public to enable.');
            return [];
          }
          // Convert *//Category markers into a real column before parsing
          text = normalizeCsvWithMarkers(text);
          const rows = CSV_parse(text);
          // CSV columns: "name","rate_per_1k_usd","min","max"
          return rows.map((r, i) => ({
            id: `csv-${i}`,
            name: r[0],
            min: Number(r[2]||0),
            max: Number(r[3]||0),
            price_per_1k: Number(r[1]||0),
            category: r[4] || '' // category from *// markers (fallback to detection later)
          }));
        }

        function CSV_parse(text) {
          const rows = [];
          let row = [], cell = '', q = false;
          for (let i = 0; i < text.length; i++) {
            const ch = text[i], nx = text[i+1];
            if (q) {
              if (ch === '"' && nx === '"') { cell += '"'; i++; }
              else if (ch === '"') { q = false; }
              else { cell += ch; }
            } else {
              if (ch === '"') q = true;
              else if (ch === ',') { row.push(cell.trim()); cell = ''; }
              else if (ch === '\n' || ch === '\r') {
                if (cell.length || row.length) { row.push(cell.trim()); rows.push(row); row = []; cell = ''; }
                if (ch === '\r' && nx === '\n') i++;
              } else {
                cell += ch;
              }
            }
          }
          if (cell.length || row.length) { row.push(cell.trim()); rows.push(row); }
          // drop header if present
          if (rows[0] && /name/i.test(rows[0][0])) rows.shift();
          return rows.filter(r => r.length >= 2);
        }

        function mergeServices(a, b) {
          const key = s => `${(s.name||'').toLowerCase()}|${Number(s.price_per_1k||0).toFixed(4)}|${s.min}|${s.max}`;
          const seen = new Set();
          const out = [];
          for (const s of [...a, ...b]) {
            const k = key(s);
            if (seen.has(k)) continue;
            seen.add(k); out.push(s);
          }
          return out;
        }

        async function load(){
          try{
            const raw = await fetchServices();
            if (!Array.isArray(raw) || !raw.length) { showErr('No services found'); return; }

            // group by detected platform and base type
            const byPlat = new Map();
            for(const s of raw){
              const plat = (s.category && s.category.trim()) ? s.category.trim() : detectPlatform(s.name||'');
              const type = getBaseType(s.name||'');
              if(!byPlat.has(plat)) byPlat.set(plat, new Map());
              const m = byPlat.get(plat); if(!m.has(type)) m.set(type, []);
              m.get(type).push(s);
            }

            // filter & normalize categories to the approved allowlist
            const filteredByPlat = new Map();
            for (const [plat, mapByType] of byPlat) {
              const disp = ALLOWED_PLAT_LABELS.get(normKey(plat));
              if (!disp) continue; // drop categories not in the CSV allowlist
              if (!filteredByPlat.has(disp)) filteredByPlat.set(disp, new Map());
              const dst = filteredByPlat.get(disp);
              for (const [t, arr] of mapByType) {
                if (!dst.has(t)) dst.set(t, []);
                dst.get(t).push(...arr);
              }
            }

            elWrap.innerHTML='';

            // categories header
            const catsGrid = document.createElement('div');
            catsGrid.className='grid';
            for (const [p, m] of filteredByPlat) {
              const catCard = document.createElement('div');
              catCard.className = 'card cat';
              catCard.style.setProperty('--plat', PLATFORM_COLORS[p] || PLATFORM_COLORS.Other);
              catCard.style.borderTop = `3px solid ${PLATFORM_COLORS[p] || PLATFORM_COLORS.Other}`;

              const catH3 = document.createElement('h3');
              catH3.style.display = 'flex';
              catH3.style.justifyContent = 'space-between';
              catH3.style.alignItems = 'center';

              const catTitle = document.createElement('span');
              catTitle.textContent = p; // using textContent, no HTML string

              const catCount = document.createElement('span');
              catCount.className = 'chip s gray';
              catCount.textContent = `${countServices(m)} services`;

              catH3.append(catTitle, catCount);

              const catSub = document.createElement('div');
              catSub.className = 'muted';
              catSub.textContent = 'Click to explore';

              catCard.replaceChildren(catH3, catSub);

              catCard.onclick = () => {
                const sec = elWrap.querySelector(`section[data-plat="${p}"]`);
                if (sec) { sec.classList.add('open'); sec.scrollIntoView({behavior:'smooth', block:'start'}); }
              };
              catsGrid.appendChild(catCard);
            }
            elWrap.appendChild(catsGrid);

            // sections
            const want = ''; // selector is disabled; show all allowed categories
            for(const [plat, byType] of filteredByPlat){
              if(want && plat!==want) continue;
              const color = PLATFORM_COLORS[plat] || PLATFORM_COLORS.Other;

              const sec = document.createElement('section');
              sec.className = 'section';
              sec.setAttribute('data-plat', plat);
              sec.style.setProperty('--plat', color);

              // head
              const head = document.createElement('div');
              head.className = 'head';

              const headRow = document.createElement('div');
              headRow.className = 'row';

              const chipPlat = document.createElement('span');
              chipPlat.className = 'chip blue s';
              chipPlat.textContent = plat;

              const chipCount = document.createElement('span');
              chipCount.className = 'chip gray s';
              chipCount.textContent = `${countServices(byType)} services`;

              headRow.append(chipPlat, chipCount);

              const headToggle = document.createElement('div');
              headToggle.className = 'muted';
              headToggle.textContent = 'Toggle';

              head.append(headRow, headToggle);

              // body + grid
              const body = document.createElement('div');
              body.className = 'body';

              const gridEl = document.createElement('div');
              gridEl.className = 'grid cards';
              body.appendChild(gridEl);

              sec.replaceChildren(head, body);
              head.addEventListener('click', () => sec.classList.toggle('open'));

              const grid = gridEl;
              for(const [type, list0] of byType){
                const list = list0.slice().sort((a,b)=>a.price_per_1k - b.price_per_1k);
                if (!list.length) continue;
                const cheapest = list[0];

                const card = document.createElement('div');
                card.className = 'card';
                // Build card header
                const h3 = document.createElement('h3');

                const brandSpan = document.createElement('span');
                brandSpan.className = 'brand';
                brandSpan.textContent = 'DropSource';

                const dot = document.createElement('span');
                dot.className = 'muted';
                dot.textContent = ' · ';

                const platSpan = document.createElement('span');
                platSpan.style.color = '#cdd7ff';
                platSpan.textContent = plat;

                const slash = document.createElement('span');
                slash.className = 'muted';
                slash.textContent = ' / ';

                const typeSpan = document.createElement('span');
                typeSpan.style.color = '#cdd7ff';
                typeSpan.textContent = type;

                h3.append(brandSpan, dot, platSpan, slash, typeSpan);

                // Chip row
                const chipsRow = document.createElement('div');
                chipsRow.className = 'row';

                const chipMin = document.createElement('span');
                chipMin.className = 'chip s gray';
                chipMin.textContent = `Min ${formatK(cheapest.min)}`;

                const chipMax = document.createElement('span');
                chipMax.className = 'chip s gray';
                chipMax.textContent = `Max ${formatK(cheapest.max)}`;

                chipsRow.append(chipMin, chipMax);

                if (/drip/i.test(cheapest.name)) {
                  const drip = document.createElement('span');
                  drip.className = 'chip s purple';
                  drip.textContent = 'Dripfeed';
                  chipsRow.appendChild(drip);
                }
                if (/refill/i.test(cheapest.name)) {
                  const refill = document.createElement('span');
                  refill.className = 'chip s green';
                  refill.textContent = 'Refill';
                  chipsRow.appendChild(refill);
                }

                // Price + buttons row
                const priceRow = document.createElement('div');
                priceRow.className = 'row';
                priceRow.style.justifyContent = 'space-between';
                priceRow.style.alignItems = 'center';

                const priceDiv = document.createElement('div');
                priceDiv.className = 'price';
                priceDiv.innerHTML = `$${cheapest.price_per_1k.toFixed(2)} <span class="muted">/ 1k</span>`;

                const btnRow = document.createElement('div');
                btnRow.className = 'row';

                const orderBtn = document.createElement('button');
                orderBtn.className = 'btn';
                orderBtn.dataset.id = `${cheapest.id}`;
                orderBtn.dataset.plat = `${plat}`;
                orderBtn.dataset.type = `${type}`;
                orderBtn.dataset.rate = `${cheapest.price_per_1k}`;
                orderBtn.dataset.min = `${cheapest.min}`;
                orderBtn.dataset.max = `${cheapest.max}`;
                orderBtn.dataset.title = `${cheapest.name}`;
                orderBtn.dataset.name = `${type}`;
                orderBtn.dataset.slug = `${slugify(plat + ' ' + type)}`;
                orderBtn.textContent = 'Order cheapest';

                const expandBtn = document.createElement('button');
                expandBtn.className = 'btn';
                expandBtn.setAttribute('data-expand','');
                expandBtn.textContent = 'View variants';

                btnRow.append(orderBtn, expandBtn);
                priceRow.append(priceDiv, btnRow);

                // Compose card
                card.replaceChildren(h3, chipsRow, priceRow);

                card.querySelector('button.btn').onclick = (ev)=>{
                  const d = ev.currentTarget.dataset;
                  const qs = new URLSearchParams({
                    id: d.id||'', name: d.name||'', title: d.title||'', plat: d.plat||'', type: d.type||'',
                    rate: d.rate||'', min: d.min||'', max: d.max||'', slug: d.slug||'', link: ''
                  });
                  ensureAuth().then((ok)=>{ if(ok!==false) location.href = `/purchase.html?${qs.toString()}`; });
                };

                const det = document.createElement('details');
                det.style.marginTop = '6px';
                const sum = document.createElement('summary');
                sum.textContent = `Variants (${list.length})`;
                const vWrap = document.createElement('div');
                vWrap.className = 'variants';
                det.replaceChildren(sum, vWrap);

                const seenLabels = new Set();
                const dedup = [];
                for (const s of list) {
                  const lbl = baseLabel(s.name) || type;
                  if (!seenLabels.has(lbl)) { seenLabels.add(lbl); dedup.push(s); }
                }
                const INITIAL_VARIANTS = 12;
                const initialList = dedup.slice(0, INITIAL_VARIANTS);

                function addVariantRow(svc){
                  const {label, chips} = summarizeVariant(svc, plat, type);
                  const row = document.createElement('div');
                  row.className = 'variant';
                  // left side: label + chips
                  const left = document.createElement('div');
                  left.className = 'row';
                  left.style.gap = '6px';
                  left.style.alignItems = 'center';
                  left.style.minWidth = '0';

                  const labelDiv = document.createElement('div');
                  labelDiv.style.fontSize = '13px';
                  labelDiv.style.color = '#d7e2f0';
                  labelDiv.style.minWidth = '0';
                  labelDiv.style.overflow = 'hidden';
                  labelDiv.style.textOverflow = 'ellipsis';
                  labelDiv.style.whiteSpace = 'nowrap';
                  labelDiv.textContent = label;

                  left.appendChild(labelDiv);
                  chips.forEach(t=>{
                    const s = document.createElement('span');
                    s.className = `chip s ${t.kind}`;
                    s.textContent = t.text;
                    left.appendChild(s);
                  });

                  // right side: price + order button
                  const right = document.createElement('div');
                  right.className = 'row';

                  const vPrice = document.createElement('div');
                  vPrice.className = 'price';
                  vPrice.style.fontSize = '13px';
                  vPrice.innerHTML = `$${svc.price_per_1k.toFixed(2)} <span class="muted">/1k</span>`;

                  const vBtn = document.createElement('button');
                  vBtn.className = 'btn';
                  vBtn.dataset.id = `${svc.id}`;
                  vBtn.dataset.plat = `${plat}`;
                  vBtn.dataset.type = `${type}`;
                  vBtn.dataset.rate = `${svc.price_per_1k}`;
                  vBtn.dataset.min = `${svc.min}`;
                  vBtn.dataset.max = `${svc.max}`;
                  vBtn.dataset.title = `${svc.name}`;
                  vBtn.dataset.name = `${type}`;
                  vBtn.dataset.slug = `${slugify(plat + ' ' + type)}`;
                  vBtn.textContent = 'Order';

                  right.append(vPrice, vBtn);

                  row.replaceChildren(left, right);
                  row.querySelector('button.btn').onclick = (ev)=>{
                    const d = ev.currentTarget.dataset;
                    const qs = new URLSearchParams({
                      id: d.id||'', name: d.name||'', title: d.title||'', plat: d.plat||'', type: d.type||'',
                      rate: d.rate||'', min: d.min||'', max: d.max||'', slug: d.slug||'', link: ''
                    });
                    ensureAuth().then((ok)=>{ if(ok!==false) location.href = `/purchase.html?${qs.toString()}`; });
                  };
                  vWrap.appendChild(row);
                }

                initialList.forEach(addVariantRow);

                if (list.length > initialList.length) {
                  const reveal = document.createElement('button');
                  reveal.className = 'btn';
                  reveal.style.margin = '8px 0 4px';
                  reveal.textContent = `Show all ${list.length} variants`;
                  reveal.onclick = () => {
                    const initialIds = new Set(initialList.map(s=>s.id));
                    for (const svc of list) { if (!initialIds.has(svc.id)) addVariantRow(svc); }
                    reveal.remove();
                  };
                  vWrap.appendChild(reveal);
                }

                card.appendChild(det);
                card.querySelector('[data-expand]').onclick=()=>{ det.open = !det.open; if(det.open){ det.scrollIntoView({behavior:'smooth', block:'nearest'}); } };
                grid.appendChild(card);
              }
              elWrap.appendChild(sec);
            }
          }catch(e){ showFatal(e); }
        }

        function countServices(map){ let n=0; for(const [,arr] of map) n+=arr.length; return n; }

        // initial load
        load();
      }catch(e){ showFatal(e); }
    })();
  </script>
</body>
</html>