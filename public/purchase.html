<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Buy Services</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b1220;           /* page background */
      --panel:#0f1726;        /* card background */
      --panel-2:#0c1422;      /* inputs background */
      --border:#1d2a3c;       /* subtle border */
      --border-2:#2a3951;     /* hover/focus border */
      --text:#d9e2f1;         /* base text */
      --muted:#8aa0bd;        /* muted text */
      --ok:#39d98a;           /* success */
      --err:#ff6b6b;          /* danger */
      --accent:#4b6bfb;       /* blue accent */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, Noto Sans, "Apple Color Emoji", "Segoe UI Emoji";
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 24px 16px 48px;
    }
    h1{margin: 0 0 16px; font-size: 22px; font-weight: 700; letter-spacing:.2px}

    /* container width similar to index page */
    .wrap{max-width:980px;margin:0 auto}

    .card{
      position: relative;
      background: radial-gradient(120% 120% at 0% 0%, rgba(255,255,255,0.04), transparent 50%) , var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      margin:16px 0;
      box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.02);
    }
    /* thin glowing top bar like category cards */
    .card::after{
      content:""; position:absolute; left:-1px; right:-1px; top:-1px; height:2px; border-radius:14px; filter:blur(.15px);
      background: linear-gradient(90deg,#4b6bfb,#6a5af9,#d66efd,#22d3ee);
    }

    label{display:block;margin:8px 0 6px;font-size:12px;color:var(--muted)}

    input,select,button{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius:10px;
      background: var(--panel-2);
      color: var(--text);
      outline: none;
      transition: border-color .15s ease, box-shadow .15s ease, background .15s ease;
    }
    input::placeholder{color:#6f85a3}
    select{appearance:none;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20" fill="%238aa0bd"><path d="M5.5 7.5l4.5 5 4.5-5" stroke="%238aa0bd" stroke-width="1.5" fill="none" stroke-linecap="round"/></svg>');background-repeat:no-repeat;background-position:right 8px center;padding-right:34px}
    input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(75,107,251,.22)}

    button{cursor:pointer;background:#0e1626}
    button:hover{border-color:var(--border-2);background:#0f1a2c}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}

    .muted{color:var(--muted)}
    .ok{color:var(--ok)}
    .err{color:var(--err)}

    .help{font-size:12px;color:var(--muted);margin-top:4px}
    /* make editable/required inputs pop */
    .editable{
      border:1.5px solid rgba(255,215,0,0.55);
      background:
        radial-gradient(120% 120% at 0% 0%, rgba(255,215,0,0.08), transparent 60%),
        var(--panel-2);
      box-shadow:
        0 0 0 1px rgba(255,215,0,0.18) inset,
        0 8px 20px rgba(0,0,0,.25);
    }
    .editable:focus{
      border-color:#ffbf36;
      box-shadow:
        0 0 0 3px rgba(255,215,0,.25),
        0 10px 24px rgba(0,0,0,.35);
      background: #0f1b2e;
    }
    .label-req::after{
      content:"✱";
      margin-left:6px;
      color:#ffd76b;
      font-weight:900;
    }
    .invalid{
      border-color:#ff6b6b !important;
      box-shadow:0 0 0 3px rgba(255,107,107,.2) !important;
    }
    input[disabled]{background:#0b1524;color:#91a7c0}

    .buttons{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
    .small{font-size:12px}
    .hidden{display:none}

    /* auth row + provider select */
    .auth{display:grid;grid-template-columns:1fr auto auto;gap:12px;margin-top:12px}
    #provider{padding:10px;border:1px solid var(--border);border-radius:10px;background:var(--panel-2)}

    /* primary/secondary buttons */
    #logout{background:#111827;border-color:#2a3951}
    #login{background:transparent}
    #create{background:linear-gradient(180deg,#1d2b45,#16233a);border-color:#3b82f6}

    .muted{color:var(--muted)}
    #bal{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,215,0,0.30);
      background: linear-gradient(90deg,#fff1a6,#ffd76b,#ffbf36,#ffd76b,#fff1a6);
      color:#1a1400;
      font-weight:800;
      letter-spacing:.2px;
      box-shadow: 0 0 0 1px rgba(255,215,0,0.15) inset, 0 2px 8px rgba(0,0,0,.25), 0 0 16px rgba(255,215,0,.08);
    }

    @media (max-width:720px){ .wrap{max-width:640px} }
    @media (max-width:520px){ .row{grid-template-columns:1fr} .auth{grid-template-columns:1fr 1fr; } #provider{grid-column:1/-1} }
  </style>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  // TODO: replace with your real values (anon key is safe to expose)
  const SUPABASE_URL  = 'https://oyibixfoiwizpphuimkl.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95aWJpeGZvaXdpenBwaHVpbWtsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwOTMzNTAsImV4cCI6MjA3MTY2OTM1MH0.MddtDHuzo9PPGJaZWG9Ny0UAuUIYUKzT2Q27OpK66Rg';
  const HAS_SUPABASE  = typeof window !== 'undefined' && !!window.supabase && SUPABASE_URL.startsWith('http');
  const supa = HAS_SUPABASE ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON) : null;
</script>
</head>
<body>
  <div class="wrap">
  <h1>Buy Services</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>User ID</label>
        <input id="uid" placeholder="user_123" />
      </div>
      <div>
        <label>Email</label>
        <input id="email" placeholder="you@example.com" />
      </div>
    </div>
    <div class="auth">
      <select id="provider" aria-label="Choose sign-in provider">
        <option value="google">Google</option>
        <option value="github">GitHub</option>
        <option value="apple">Apple</option>
        <option value="discord">Discord</option>
        <option value="email">Email link</option>
      </select>
      <button id="login">Sign in</button>
      <button id="logout">Sign out</button>
    </div>
    
    <p class="muted">Balance: <b id="bal">$0.00</b></p>
  </div>

  <div class="card">
      <label>Service</label>
      <input id="svcName" disabled />

      <div class="row">
        <div>
          <label>Category</label>
          <input id="cat" placeholder="instagram" disabled />
        </div>
        <div>
          <label>Rate / 1k (USD)</label>
          <input id="rate" disabled />
        </div>
      </div>

      <label id="urlLabel" class="label-req">Target URL</label>
      <input id="url" class="editable" placeholder="https://example.com/..." required />

      <div class="row">
        <div>
          <label id="qtyLabel" class="label-req">Quantity</label>
          <input id="qty" class="editable" type="number" value="100" min="1" required />
          <p class="help" id="minmax"></p>
        </div>
        <div>
          <label>Estimated Cost</label>
          <input id="est" disabled />
        </div>
      </div>

      <div class="buttons">
        <button id="create">Create Order</button>
      </div>
      <p id="msg" class="muted"></p>
  </div>

<script>
const BASE = location.origin;
const $ = (id)=>document.getElementById(id);

// persist pseudo-login locally (temporary until real auth)
const KEY='ds_user';
const KEY_PROV='ds_provider';
function loadProvider(){ return localStorage.getItem(KEY_PROV) || 'google'; }
function saveProvider(p){ localStorage.setItem(KEY_PROV, p); }
function loadUser(){ try{ return JSON.parse(localStorage.getItem(KEY)||'{}'); }catch{ return {}; } }
function saveUser(uid,email){ localStorage.setItem(KEY, JSON.stringify({uid,email})); }
function applyUser(){
  const u=loadUser();
  if(u.uid) $('uid').value=u.uid;
  if(u.email) $('email').value=u.email;
  if ($('provider')) $('provider').value = loadProvider();
}

// --- helpers ---
function cents(n){ return `$${(n/100).toFixed(2)}`; }
function params(){ return Object.fromEntries(new URLSearchParams(location.search)); }
function slugify(s){
  return String(s || '')
    .toLowerCase()
    .normalize('NFKD')
    .replace(/[\u0300-\u036f]/g, '')       // strip diacritics
    .replace(/[^\w\s-]/g, ' ')             // remove emojis/punct
    .replace(/\s+/g, ' ')                  // collapse spaces
    .trim()
    .replace(/\s/g, '-');                  // to kebab
}

function categorizeFromName(name){
  const n = String(name||'').toLowerCase();
  if (n.includes('instagram') || n.includes('ig')) return 'instagram';
  if (n.includes('threads')) return 'threads';
  if (n.includes('youtube') || n.includes('yt')) return 'youtube';
  if (n.includes('tiktok')) return 'tiktok';
  if (n.includes('facebook') || n.includes('fb')) return 'facebook';
  if (n.includes('twitter') || n.includes('x ' ) || n.startsWith('x ')) return 'x';
  if (n.includes('twitch')) return 'twitch';
  if (n.includes('discord')) return 'discord';
  if (n.includes('telegram')) return 'telegram';
  if (n.includes('snapchat')) return 'snapchat';
  if (n.includes('spotify')) return 'spotify';
  if (n.includes('soundcloud')) return 'soundcloud';
  if (n.includes('pinterest')) return 'pinterest';
  if (n.includes('google')) return 'google business reviews';
  if (n.includes('web') && n.includes('traffic')) return 'webtraffic';
  return 'other';
}

// --- minimal fetch helper that always adds user headers ---
function currentUser(){
  const u = loadUser();
  const uid = (u.uid || '').trim() || ($('uid')?.value || '').trim();
  const email = (u.email || '').trim() || ($('email')?.value || '').trim();
  return { uid, email };
}
async function api(url, opts={}){
  const { uid, email } = currentUser();
  const headers = Object.assign(
    { 'content-type':'application/json' },
    { 'x-user-id': uid || '', 'x-user-email': email || '' },
    opts.headers || {}
  );
  const res = await fetch(url, Object.assign({ method: 'GET', headers }, opts));
  const text = await res.text();
  let json = null; try{ json = JSON.parse(text); }catch{}
  return { ok: res.ok, status: res.status, json, text };
}
async function refreshBalance(){
  const { uid, email } = currentUser();
  if (!uid || !email){
    $('bal').textContent = '$0.00';
    return;
  }
  const r = await api(`${BASE}/api/wallet/get`);
  if (r.ok && r.json){
    $('bal').textContent = cents(r.json.balance_cents || 0);
  } else {
    $('bal').textContent = '—';
  }
}

function setAuthUI(loggedIn){
  const has = !!loggedIn;
  if ($('login')) $('login').classList.toggle('hidden', has);
  if ($('logout')) $('logout').classList.toggle('hidden', !has);
  if ($('uid')) $('uid').disabled = has;
  if ($('email')) $('email').disabled = has;
  if ($('provider')) $('provider').disabled = has;
}
async function bootstrapAuth(){
  if (!supa) { setAuthUI(false); return; }
  const { data: { user } } = await supa.auth.getUser();
  if (user){
    saveUser(user.id, user.email || user.user_metadata?.email || '');
    applyUser();
    setAuthUI(true);
    await refreshBalance();
  } else {
    setAuthUI(false);
  }
  supa.auth.onAuthStateChange(async (_ev, session) => {
    const u = session?.user || null;
    if (u){
      saveUser(u.id, u.email || u.user_metadata?.email || '');
      applyUser();
      setAuthUI(true);
      await refreshBalance();
    } else {
      localStorage.removeItem(KEY);
      applyUser();
      setAuthUI(false);
      await refreshBalance();
    }
  });
  if ($('provider')){
    $('provider').onchange = ()=> saveProvider($('provider').value);
  }
  if ($('login')) $('login').onclick = async ()=>{
    if (!supa){ alert('Auth not configured'); return; }
    const provider = $('provider') ? $('provider').value : 'google';
    saveProvider(provider);
    if (provider === 'email'){
      const email = prompt('Enter your email for a magic sign-in link:');
      if (!email) return;
      const { error } = await supa.auth.signInWithOtp({
        email,
        options:{ emailRedirectTo: location.href }
      });
      if (error) alert(error.message || 'Email sign-in failed');
      else alert('Check your email for the sign-in link.');
      return;
    }
    await supa.auth.signInWithOAuth({
      provider,
      options:{ redirectTo: location.href }
    });
  };
  if ($('logout')) $('logout').onclick = async ()=>{
    if (!supa) return;
    await supa.auth.signOut();
  };
}

// CSV columns (exact): name,rate_per_1k_usd,min,max,(optional) category
let catalog = [];
// lookup by lower-name and by slug
let byName = [];

async function loadCSV() {
  const r = await fetch('/smmgoals.services.csv', { cache:'no-store' });
  const text = await r.text();
  const lines = text.split(/\r?\n/).filter(Boolean);
  const [h, ...rows] = lines;
  const headers = h.split(',').map(s => s.replace(/^"|"$/g,'').trim().toLowerCase());
  const idx = {
    name: headers.indexOf('name'),
    rate: headers.indexOf('rate_per_1k_usd'),
    min: headers.indexOf('min'),
    max: headers.indexOf('max'),
    category: headers.indexOf('category')
  };

  catalog = rows.map((line) => {
    const cols = [];
    let cur = '', inQ = false;
    for (let i=0;i<line.length;i++){
      const ch = line[i];
      if (ch === '"') {
        if (inQ && line[i+1] === '"') { cur+='"'; i++; }
        else inQ = !inQ;
      } else if (ch === ',' && !inQ) { cols.push(cur); cur=''; }
      else cur += ch;
    }
    cols.push(cur);
    const name = (cols[idx.name]||'').replace(/^"|"$/g,'').trim();
    const rate = parseFloat((cols[idx.rate]||'0').replace(/"/g,'')) || 0;
    const min = parseInt((cols[idx.min]||'0').replace(/"/g,''),10) || 0;
    const max = parseInt((cols[idx.max]||'0').replace(/"/g,''),10) || 0;
    let category = (cols[idx.category]||'').replace(/^"|"$/g,'').trim();
    if (!category) category = categorizeFromName(name);
    const slug = slugify(name);
    return { name, rate, min, max, category, slug };
  }).filter(x => x.name && x.rate > 0);

  // rebuild lookups
  byName = new Map();
  for (const s of catalog){
    byName.set(s.name.toLowerCase(), s);
    byName.set(s.slug, s);
  }

}

let chosen = null; // selected service record, set during init

function selectedRecord(){
  return chosen;
}


function updateFromChosen() {
  const rec = selectedRecord();
  if (!rec) return;
  $('svcName').value = rec.name;
  $('cat').value = (rec.category || categorizeFromName(rec.name));
  $('cat').disabled = true;
  $('rate').value = `$${rec.rate.toFixed(2)} / 1k`;
  $('qty').min = Math.max(1, rec.min || 1);
  $('qty').max = rec.max || 1000000;
  $('qty').value = Math.max(parseInt($('qty').value || '0', 10) || rec.min || 1, rec.min || 1);
  // Update qty label with min/max
  if (document.getElementById('qtyLabel')) {
    document.getElementById('qtyLabel').textContent = `Quantity (min ${$('qty').min} / max ${$('qty').max})`;
  }
  estimate();
  const mm = [];
  if (rec?.min) mm.push(`min ${rec.min}`);
  if (rec?.max) mm.push(`max ${rec.max}`);
  $('minmax').textContent = mm.length ? `Provider limits: ${mm.join(' · ')}` : '';
}

function estimate() {
  const rec = selectedRecord();
  const qtyEl = $('qty');
  const urlEl = $('url');
  const qty = Number(qtyEl.value || 0);
  const pricePerUnitCents = rec ? Math.round(rec.rate * 100 / 1000) : 0;

  let invalid = false;
  if (rec) {
    const min = Math.max(1, rec.min || 1);
    const max = rec.max || 1000000;
    if (qty < min || qty > max) invalid = true;
  } else {
    invalid = true;
  }

  qtyEl.classList.toggle('invalid', invalid);
  if (invalid) {
    $('est').value = '—';
  } else {
    $('est').value = cents(pricePerUnitCents * qty);
  }
  updateCreateButtonState();
}

function updateCreateButtonState(){
  const hasTarget = ($('url').value || '').trim().length > 0;
  const hasQty = ($('qty').value || '').trim().length > 0 && !$('qty').classList.contains('invalid');
  $('create').disabled = !(hasTarget && hasQty);
}

// Try to resolve a provider service id by name using your live /api/smm listings
async function resolveServiceIdByName(name) {
  const q = encodeURIComponent(name);
  const r = await api(`${BASE}/api/smm?action=services&q=${q}`);
  const list = Array.isArray(r.json) ? r.json : [];
  if (!list.length) return null;
  // naive best-match by case-insensitive substring, prefer cheapest
  const needle = name.toLowerCase();
  const candidates = list
    .filter(s => String(s.name||'').toLowerCase().includes(needle))
    .sort((a,b) => (a.price_per_1k||Infinity) - (b.price_per_1k||Infinity));
  return (candidates[0] && candidates[0].id) || list[0].id || null;
}

function findServiceFromQuery(q){
  if (!q) return null;
  const s = String(q);
  const tryKeys = [
    s,
    decodeURIComponent(s || ''),
    s.replace(/\s+/g,' ').trim()
  ];
  // exact by slug or lower-name
  for (const k of tryKeys){
    const m = byName.get(slugify(k)) || byName.get(String(k).toLowerCase());
    if (m) return m;
  }
  // fuzzy: substring on slug
  const needle = slugify(s).replace(/-/g,' ');
  let best = null;
  for (const rec of catalog){
    const hay = rec.slug.replace(/-/g,' ');
    if (hay.includes(needle)) { best = rec; break; }
  }
  return best;
}

// hook up UI
$('qty').addEventListener('input', estimate);
$('url').addEventListener('input', updateCreateButtonState);

$('create').onclick = async () => {
  $('msg').className = 'muted';
  $('msg').textContent = 'Resolving service...';
  {
    const { uid, email } = currentUser();
    if (!uid || !email){ $('msg').textContent = '❌ Sign in (or enter User ID + Email) first'; $('msg').className = 'err'; return; }
  }
  const rec = selectedRecord();
  const name = rec?.name || '';
  const target = $('url').value.trim();
  const qty = Number($('qty').value || 0);
  if (!target) { $('msg').textContent = '❌ Enter a target URL'; $('msg').className = 'err'; return; }
  if (!rec) { $('msg').textContent = '❌ No service selected. Go back and choose a service.'; $('msg').className = 'err'; return; }

  const serviceId = await resolveServiceIdByName(name);
  if (!serviceId) { $('msg').textContent = '❌ Could not match this service to provider'; $('msg').className = 'err'; return; }

  $('msg').textContent = 'Placing order...';

  const r = await api(`${BASE}/api/smm`, {
    method:'POST',
    body: JSON.stringify({ action:'add', service: serviceId, link: target, quantity: qty })
  });

  if (r.ok && r.json && r.json.order) {
    $('msg').className = 'ok';
    $('msg').textContent = `✅ Order ${r.json.order} placed.`;
    refreshBalance();
  } else {
    const err = r.json?.error || r.text || 'error';
    $('msg').className = 'err';
    $('msg').textContent = `❌ ${err}`;
  }
};


// init
(async function init(){
  applyUser();
  if ($('provider')) $('provider').value = loadProvider();
  await bootstrapAuth();
  await refreshBalance();
  await loadCSV();
  const qp = params();
  let picked = null;
  if (qp.idx && catalog[Number(qp.idx)]) picked = catalog[Number(qp.idx)];
  if (!picked && qp.slug) picked = byName.get(String(qp.slug).toLowerCase()) || byName.get(String(qp.slug));
  if (!picked && qp.name) picked = findServiceFromQuery(qp.name);

  chosen = picked || null;
  if (!chosen){
    $('msg').className = 'err';
    $('msg').textContent = '❌ No service selected. Go back and choose a service.';
    return;
  }
  updateFromChosen();

  // Pre-fill target URL if supplied
  if (qp.link) $('url').value = qp.link;
  estimate();
  updateCreateButtonState();
})();
</script>
</div>
</body>
</html>