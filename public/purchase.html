<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DropSource — Buy Services</title>
  <style>
    :root{--bg:#0b0f16;--fg:#e6edf7;--muted:#9fb3c8;--chip:#1a2230;--brand:#8aa6ff;--card:#0f1520;--line:#1b2434;--btn:#1b2a45;--btn-fg:#e6edf7}
    *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.6 system-ui,Segoe UI,Helvetica,Arial,sans-serif}
    header{position:sticky;top:0;background:#0d1421;border-bottom:1px solid var(--line);padding:10px 12px;z-index:5}
    .header-row{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:10px;max-width:960px;margin:0 auto}
    #brandbar{justify-self:start}.brand{color:var(--brand);font-weight:800}
    #authbar{justify-self:end;gap:8px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input,button{background:#0e1726;color:var(--fg);border:1px solid var(--line);border-radius:10px;padding:11px 12px}
    button{cursor:pointer;background:var(--btn);color:var(--btn-fg)}
    .section{border:1px solid var(--line);border-radius:16px;margin:14px auto;max-width:960px;overflow:hidden;background:var(--card);box-shadow:0 10px 40px rgba(0,0,0,.25)}
    .section .hd{display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid var(--line);background:linear-gradient(90deg,var(--line),transparent)}
    .section .bd{padding:14px}
    .muted{color:var(--muted)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{display:block;margin:2px 0 6px 4px;color:#c9d6ea;font-weight:600}
    .big{font-size:16px}
    .pill{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:6px 10px;border:1px solid rgba(255,215,0,.35);background:rgba(255,215,0,.08);color:#ffd86b;font-weight:800}
    .pill .sym{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:999px;background:linear-gradient(180deg,#ffd700,#ffb400);color:#111;font-weight:900;font-size:12px}
    .btn.gold{background:linear-gradient(180deg,#ffe07d,#ffc933);color:#1b1400;border-color:#815b00;font-weight:800}
    .btn.gold:hover{filter:brightness(1.05)}
    .inline-help{font-size:12px;color:#9fb3c8;margin-left:6px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <div class="header-row">
      <div class="row" id="brandbar">
        <div class="brand">DropSource</div>
        <div class="muted">Buy Services</div>
      </div>
      <div class="row" style="justify-self:center">
        <span id="balancePill" class="pill" style="display:none"><span class="sym">$</span><span id="balanceAmt">$0.00</span></span>
      </div>
      <div id="authbar" class="row">
        <div id="userInfo" class="row" style="display:none"></div>
        <button id="loginBtn" class="btn">Sign in</button>
        <button id="logoutBtn" class="btn" style="display:none">Sign out</button>
      </div>
    </div>
  </header>

  <!-- Account -->
  <div class="section">
    <div class="hd"><div class="big">Account</div></div>
    <div class="bd grid2">
      <div>
        <label>User ID</label>
        <input id="userId" disabled />
      </div>
      <div>
        <label>Email</label>
        <input id="userEmail" disabled />
      </div>
      <div class="row" style="grid-column:1 / -1; justify-content:space-between">
        <div class="row">
          <span class="muted">Provider</span>
          <span id="provider" class="chip">—</span>
        </div>
        <div class="row">
          <button id="depositBtn" class="btn gold">Deposit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Service -->
  <div class="section">
    <div class="hd"><div class="big">Service</div></div>
    <div class="bd grid2">
      <div>
        <label>Category</label>
        <input id="fieldCat" disabled />
      </div>
      <div>
        <label>Rate / 1k (USD)</label>
        <input id="fieldRate" disabled />
      </div>
      <div style="grid-column:1 / -1">
        <label>Service</label>
        <input id="fieldSvc" disabled />
      </div>

      <div style="grid-column:1 / -1">
        <label>Target URL <span class="inline-help">(required)</span></label>
        <input id="fieldUrl" placeholder="https://example.com/..." />
      </div>
      <div>
        <label>Quantity <span id="qtyHelp" class="inline-help"></span></label>
        <input id="fieldQty" type="number" min="0" step="1" />
      </div>
      <div>
        <label>Estimated Cost</label>
        <input id="fieldCost" disabled />
      </div>
      <div style="grid-column:1 / -1">
        <button id="createBtn" class="btn" style="width:100%">Create Order</button>
      </div>
    </div>
  </div>

  <script>
    // @ts-nocheck
    (function(){
      const SUPABASE_URL = window.SUPABASE_URL || 'https://oyibixfoiwizpphuimkl.supabase.co';
      const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95aWJpeGZvaXdpenBwaHVpbWtsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwOTMzNTAsImV4cCI6MjA3MTY2OTM1MH0.MddtDHuzo9PPGJaZWG9Ny0UAuUIYUKzT2Q27OpK66Rg';
      const sb = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;

      const $ = (s)=>document.querySelector(s);
      const elCat  = $('#fieldCat');
      const elSvc  = $('#fieldSvc');
      const elRate = $('#fieldRate');
      const elUrl  = $('#fieldUrl');
      const elQty  = $('#fieldQty');
      const elCost = $('#fieldCost');
      const elQtyHelp = $('#qtyHelp');

      const qs = new URLSearchParams(location.search);
      function pick(...keys){
        for(const k of keys){
          const v = qs.get(k);
          if(v != null && v !== '' && v !== 'undefined' && v !== 'null') return v;
        }
        return '';
      }
      const payload = {
        id:   pick('id','service_id','sid'),
        plat: pick('category','plat','platform'),
        name: pick('service','title','name'),
        rate: Number(pick('rate','price','price_per_1k')),
        min:  Number(pick('min','minimum')),
        max:  Number(pick('max','maximum')),
      };

      // Fill/lock
      elCat.value  = payload.plat || '';
      elSvc.value  = payload.name || '';
      elRate.value = Number.isFinite(payload.rate) ? ('$' + payload.rate.toFixed(2) + ' / 1k') : '';
      if (Number.isFinite(payload.min)) elQty.min = String(Math.max(0, payload.min));
      if (Number.isFinite(payload.max) && payload.max > 0) elQty.max = String(payload.max);
      elQtyHelp.textContent = [
        Number.isFinite(payload.min) ? ('min ' + payload.min) : '',
        Number.isFinite(payload.max) && payload.max > 0 ? ('max ' + payload.max) : ''
      ].filter(Boolean).join(' · ');

      // Auth/UI
      const elUserId = $('#userId');
      const elUserEmail = $('#userEmail');
      const elProvider = $('#provider');
      const elLogin = $('#loginBtn');
      const elLogout = $('#logoutBtn');
      const elDeposit = $('#depositBtn');
      const elBalWrap = $('#balancePill');
      const elBalAmt  = $('#balanceAmt');

      if (elDeposit) elDeposit.onclick = ()=>location.href='/balance.html';

      async function refreshBalance(){
        if(!sb || !elBalAmt) return;
        const { data:{ user } } = await sb.auth.getUser();
        const email = user?.email || '';
        let balance = 0;
        try{
          const res = await fetch(`/api/wallet?email=${encodeURIComponent(email)}`, { cache:'no-store' });
          if (res.ok) {
            const j = await res.json();
            if (j.balance_cents != null) balance = Number(j.balance_cents)/100;
            else if (j.balance_usd != null) balance = Number(j.balance_usd);
            else if (j.balance != null) balance = Number(j.balance);
          }
        }catch(_){}
        if (!Number.isFinite(balance)) balance = 0;
        elBalAmt.textContent = `$${balance.toFixed(2)}`;
      }
      async function refreshAuthUI(){
        if(!sb) return;
        const { data:{ session } } = await sb.auth.getSession();
        const user = session?.user;
        elLogin.style.display  = user ? 'none' : '';
        elLogout.style.display = user ? '' : 'none';
        elBalWrap.style.display = user ? 'inline-flex' : 'none';
        if (user){
          elUserId.value = user.id;
          elUserEmail.value = user.email || '';
          elProvider.textContent = (user.app_metadata?.provider || '—');
          await refreshBalance();
        }
      }
      refreshAuthUI();
      if (sb) sb.auth.onAuthStateChange(refreshAuthUI);
      if (elLogin) elLogin.onclick = async ()=>{
        if(!sb) return;
        const { data } = await sb.auth.signInWithOAuth({ provider:'google', options:{ redirectTo: location.href } });
        if (data?.url) location.assign(data.url);
      };
      if (elLogout) elLogout.onclick = ()=>sb && sb.auth.signOut().then(refreshAuthUI);

      function recalc(){
        const qty = Number(elQty.value || 0);
        const rate = Number(payload.rate || 0);
        const cost = qty * (rate/1000);
        elCost.value = Number.isFinite(cost) ? ('$' + cost.toFixed(2)) : '';
      }
      elQty.addEventListener('input', recalc);
      recalc();

      // Create order
      $('#createBtn').onclick = async ()=>{
        if (!sb) return alert('Auth not configured.');
        const { data:{ session } } = await sb.auth.getSession();
        if (!session) { alert('Please sign in to place an order.'); return; }

        const link = (elUrl.value||'').trim();
        const qty  = Number(elQty.value||0);
        if (!link) return alert('Please enter a target URL.');
        if (!Number.isFinite(qty) || qty <= 0) return alert('Enter a quantity.');
        if (payload.min && qty < payload.min) return alert(`Minimum is ${payload.min}.`);
        if (payload.max && qty > payload.max) return alert(`Maximum is ${payload.max}.`);

        try{
          const body = {
            id: payload.id,
            link,
            quantity: qty,
            rate_per_1k: payload.rate,
            platform: payload.plat,
            service_name: payload.name
          };
          const res = await fetch('/api/orders/create', {
            method:'POST',
            headers:{'content-type':'application/json'},
            body: JSON.stringify(body)
          });
          if (!res.ok){
            const msg = await res.text();
            throw new Error(msg || 'Order failed');
          }
          alert('Order created!');
          location.href = '/';
        }catch(err){
          console.error(err);
          alert('Could not create order: ' + (err.message || err));
        }
      };
    })();
  </script>
</body>
</html>