<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Buy Services</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:system-ui,Segoe UI,Arial,sans-serif;max-width:680px;margin:24px auto;padding:0 16px}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:16px 0}
    label{display:block;margin:8px 0 4px}
    input,select,button{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px}
    button{cursor:pointer}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .muted{color:#666}
    .ok{color:#0a7a0a}
    .err{color:#b00020}
  .help{font-size:12px;color:#777;margin-top:4px}
  input[disabled]{background:#f6f6f6}
  .buttons{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
  .small{font-size:12px}
  .hidden{display:none}
  .buttons button#logout{background:#111;color:#fff}
  .buttons button#login{background:#fff;border:1px solid #ccc}
  </style>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  // TODO: replace with your real values (anon key is safe to expose)
  const SUPABASE_URL  = 'https://oyibixfoiwizpphuimkl.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im95aWJpeGZvaXdpenBwaHVpbWtsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYwOTMzNTAsImV4cCI6MjA3MTY2OTM1MH0.MddtDHuzo9PPGJaZWG9Ny0UAuUIYUKzT2Q27OpK66Rg';
  const HAS_SUPABASE  = typeof window !== 'undefined' && !!window.supabase && SUPABASE_URL.startsWith('http');
  const supa = HAS_SUPABASE ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON) : null;
</script>
</head>
<body>
  <h1>Purchase</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>User ID</label>
        <input id="uid" placeholder="user_123" />
      </div>
      <div>
        <label>Email</label>
        <input id="email" placeholder="you@example.com" />
      </div>
    </div>
    <button id="chk">Check Wallet</button>
    <div class="buttons">
      <button id="login">Sign in with Google</button>
      <button id="logout">Sign out</button>
    </div>
    <p class="help small">Tip: we’ll remember your user id + email on this device only. (Full login coming soon.)</p>
    <p class="muted">Balance: <b id="bal">$0.00</b></p>
  </div>

  <div class="card">
      <div class="row">
        <div>
          <label>Filter by category</label>
          <select id="fcat"><option value="">All</option></select>
        </div>
        <div>
          <label>Search</label>
          <input id="find" placeholder="type to filter services"/>
        </div>
      </div>
      <label>Service</label>
      <select id="svc"></select>

      <div class="row">
        <div>
          <label>Category</label>
          <input id="cat" placeholder="instagram" disabled />
        </div>
        <div>
          <label>Rate / 1k (USD)</label>
          <input id="rate" disabled />
        </div>
      </div>

      <label>Target URL</label>
      <input id="url" placeholder="https://example.com/..." />

      <div class="row">
        <div>
          <label>Quantity</label>
          <input id="qty" type="number" value="100" min="1" />
        </div>
        <div>
          <label>Estimated Cost</label>
          <input id="est" disabled />
        </div>
      </div>

      <div class="buttons">
        <button id="create">Create Order</button>
        <button id="add5">+ $5 via Square</button>
      </div>
      <div class="buttons">
        <button id="add5c">+ $5 via Crypto (Coinbase)</button>
        <button id="addCustom">Add Custom Amount</button>
      </div>
      <p class="help" id="minmax"></p>
      <p id="msg" class="muted"></p>
  </div>

<script>
const BASE = location.origin;
const $ = (id)=>document.getElementById(id);

// persist pseudo-login locally (temporary until real auth)
const KEY='ds_user';
function loadUser(){ try{ return JSON.parse(localStorage.getItem(KEY)||'{}'); }catch{ return {}; } }
function saveUser(uid,email){ localStorage.setItem(KEY, JSON.stringify({uid,email})); }
function applyUser(){ const u=loadUser(); if(u.uid) $('uid').value=u.uid; if(u.email) $('email').value=u.email; }

// --- helpers ---
function cents(n){ return `$${(n/100).toFixed(2)}`; }
function params(){ return Object.fromEntries(new URLSearchParams(location.search)); }
function slugify(s){
  return String(s || '')
    .toLowerCase()
    .normalize('NFKD')
    .replace(/[\u0300-\u036f]/g, '')       // strip diacritics
    .replace(/[^\w\s-]/g, ' ')             // remove emojis/punct
    .replace(/\s+/g, ' ')                  // collapse spaces
    .trim()
    .replace(/\s/g, '-');                  // to kebab
}

// --- minimal fetch helper that always adds user headers ---
function currentUser(){
  const u = loadUser();
  const uid = (u.uid || '').trim() || ($('uid')?.value || '').trim();
  const email = (u.email || '').trim() || ($('email')?.value || '').trim();
  return { uid, email };
}
async function api(url, opts={}){
  const { uid, email } = currentUser();
  const headers = Object.assign(
    { 'content-type':'application/json' },
    { 'x-user-id': uid || '', 'x-user-email': email || '' },
    opts.headers || {}
  );
  const res = await fetch(url, Object.assign({ method: 'GET', headers }, opts));
  const text = await res.text();
  let json = null; try{ json = JSON.parse(text); }catch{}
  return { ok: res.ok, status: res.status, json, text };
}
async function refreshBalance(){
  const { uid, email } = currentUser();
  if (!uid || !email){
    $('bal').textContent = '$0.00';
    return;
  }
  const r = await api(`${BASE}/api/wallet/get`);
  if (r.ok && r.json){
    $('bal').textContent = cents(r.json.balance_cents || 0);
  } else {
    $('bal').textContent = '—';
  }
}

function setAuthUI(loggedIn){
  const has = !!loggedIn;
  if ($('login')) $('login').classList.toggle('hidden', has);
  if ($('logout')) $('logout').classList.toggle('hidden', !has);
  if ($('uid')) $('uid').disabled = has;
  if ($('email')) $('email').disabled = has;
}
async function bootstrapAuth(){
  if (!supa) { setAuthUI(false); return; }
  const { data: { user } } = await supa.auth.getUser();
  if (user){
    saveUser(user.id, user.email || user.user_metadata?.email || '');
    applyUser();
    setAuthUI(true);
    await refreshBalance();
  } else {
    setAuthUI(false);
  }
  supa.auth.onAuthStateChange(async (_ev, session) => {
    const u = session?.user || null;
    if (u){
      saveUser(u.id, u.email || u.user_metadata?.email || '');
      applyUser();
      setAuthUI(true);
      await refreshBalance();
    } else {
      localStorage.removeItem(KEY);
      applyUser();
      setAuthUI(false);
      await refreshBalance();
    }
  });
  if ($('login')) $('login').onclick = async ()=>{
    if (!supa){ alert('Auth not configured'); return; }
    await supa.auth.signInWithOAuth({
      provider:'google',
      options:{ redirectTo: location.href }
    });
  };
  if ($('logout')) $('logout').onclick = async ()=>{
    if (!supa) return;
    await supa.auth.signOut();
  };
}

// CSV columns (exact): name,rate_per_1k_usd,min,max,(optional) category
let catalog = [];
// lookup by lower-name and by slug
let byName = [];

async function loadCSV() {
  const r = await fetch('/smmgoals.services.csv', { cache:'no-store' });
  const text = await r.text();
  const lines = text.split(/\r?\n/).filter(Boolean);
  const [h, ...rows] = lines;
  const headers = h.split(',').map(s => s.replace(/^"|"$/g,'').trim().toLowerCase());
  const idx = {
    name: headers.indexOf('name'),
    rate: headers.indexOf('rate_per_1k_usd'),
    min: headers.indexOf('min'),
    max: headers.indexOf('max'),
    category: headers.indexOf('category')
  };

  catalog = rows.map((line) => {
    const cols = [];
    let cur = '', inQ = false;
    for (let i=0;i<line.length;i++){
      const ch = line[i];
      if (ch === '"') {
        if (inQ && line[i+1] === '"') { cur+='"'; i++; }
        else inQ = !inQ;
      } else if (ch === ',' && !inQ) { cols.push(cur); cur=''; }
      else cur += ch;
    }
    cols.push(cur);
    const name = (cols[idx.name]||'').replace(/^"|"$/g,'').trim();
    const rate = parseFloat((cols[idx.rate]||'0').replace(/"/g,'')) || 0;
    const min = parseInt((cols[idx.min]||'0').replace(/"/g,''),10) || 0;
    const max = parseInt((cols[idx.max]||'0').replace(/"/g,''),10) || 0;
    let category = (cols[idx.category]||'').replace(/^"|"$/g,'').trim();
    if (!category) category = categorizeFromName(name);
    const slug = slugify(name);
    return { name, rate, min, max, category, slug };
  }).filter(x => x.name && x.rate > 0);

  // rebuild lookups
  byName = new Map();
  for (const s of catalog){
    byName.set(s.name.toLowerCase(), s);
    byName.set(s.slug, s);
  }

  // build category filter list
  const cats = Array.from(new Set(catalog.map(s => s.category))).sort((a,b)=>a.localeCompare(b));
  const fcat = $('fcat');
  fcat.innerHTML = '<option value="">All</option>' + cats.map(c => `<option value="${c}">${c}</option>`).join('');

  // render options (unfiltered list – we'll filter dynamically)
  const el = $('svc');
  el.innerHTML = catalog.map(s => {
    const label = s.name;
    return `<option value="${s.name.replace(/"/g,'&quot;')}" data-cat="${s.category}" data-slug="${s.slug}">${label}</option>`;
  }).join('');
}

function selectedRecord(){
  const sel = $('svc');
  const opt = sel.selectedOptions[0];
  const slug = opt?.dataset.slug;
  const name = opt?.value || '';
  return (slug && byName.get(slug)) || byName.get(name.toLowerCase()) || null;
}

function applyFilters(){
  const q = $('find').value.trim().toLowerCase();
  const cat = $('fcat').value;
  const el = $('svc');
  const keep = [];
  for (const opt of Array.from(el.options)){
    const matchesCat = !cat || opt.dataset.cat === cat;
    const matchesText = !q || opt.textContent.toLowerCase().includes(q);
    const show = matchesCat && matchesText;
    opt.hidden = !show;
    if (show) keep.push(opt);
  }
  // ensure one visible option is selected
  const currentVisible = keep.find(o => o.selected);
  if (!currentVisible && keep.length) keep[0].selected = true;
  updateFromSelection();
}

function updateFromSelection() {
  const rec = selectedRecord();
  if (!rec) return;
  const name = rec.name;
  $('cat').value = (rec.category || categorizeFromName(rec.name));
  $('cat').disabled = true;
  $('rate').value = `$${rec.rate.toFixed(2)} / 1k`;
  $('qty').min = Math.max(1, rec.min || 1);
  $('qty').max = rec.max || 1000000;
  $('qty').value = Math.max(parseInt($('qty').value || '0', 10) || rec.min || 1, rec.min || 1);
  estimate();
  const mm = [];
  if (rec?.min) mm.push(`min ${rec.min}`);
  if (rec?.max) mm.push(`max ${rec.max}`);
  $('minmax').textContent = mm.length ? `Provider limits: ${mm.join(' · ')}` : '';
}

function estimate() {
  const rec = selectedRecord();
  const qty = Number($('qty').value || 0);
  const pricePerUnitCents = rec ? Math.round(rec.rate * 100 / 1000) : 0;
  $('est').value = cents(pricePerUnitCents * qty);
}

// Try to resolve a provider service id by name using your live /api/smm listings
async function resolveServiceIdByName(name) {
  const q = encodeURIComponent(name);
  const r = await api(`${BASE}/api/smm?action=services&q=${q}`);
  const list = Array.isArray(r.json) ? r.json : [];
  if (!list.length) return null;
  // naive best-match by case-insensitive substring, prefer cheapest
  const needle = name.toLowerCase();
  const candidates = list
    .filter(s => String(s.name||'').toLowerCase().includes(needle))
    .sort((a,b) => (a.price_per_1k||Infinity) - (b.price_per_1k||Infinity));
  return (candidates[0] && candidates[0].id) || list[0].id || null;
}

function findServiceFromQuery(q){
  if (!q) return null;
  const s = String(q);
  const tryKeys = [
    s,
    decodeURIComponent(s || ''),
    s.replace(/\s+/g,' ').trim()
  ];
  // exact by slug or lower-name
  for (const k of tryKeys){
    const m = byName.get(slugify(k)) || byName.get(String(k).toLowerCase());
    if (m) return m;
  }
  // fuzzy: substring on slug
  const needle = slugify(s).replace(/-/g,' ');
  let best = null;
  for (const rec of catalog){
    const hay = rec.slug.replace(/-/g,' ');
    if (hay.includes(needle)) { best = rec; break; }
  }
  return best;
}

// hook up UI
$('chk').onclick = async ()=>{
  const uid = ($('uid').value || '').trim();
  const email = ($('email').value || '').trim();
  if (uid && email) saveUser(uid, email);
  await refreshBalance();
};
$('svc').addEventListener('change', updateFromSelection);
$('qty').addEventListener('input', estimate);
$('find').addEventListener('input', applyFilters);
$('fcat').addEventListener('change', applyFilters);

$('create').onclick = async () => {
  $('msg').className = 'muted';
  $('msg').textContent = 'Resolving service...';
  {
    const { uid, email } = currentUser();
    if (!uid || !email){ $('msg').textContent = '❌ Sign in (or enter User ID + Email) first'; $('msg').className = 'err'; return; }
  }
  const name = $('svc').value;
  const target = $('url').value.trim();
  const qty = Number($('qty').value || 0);
  if (!target) { $('msg').textContent = '❌ Enter a target URL'; $('msg').className = 'err'; return; }
  if (!name || !byName.has(name.toLowerCase())) { $('msg').textContent = '❌ Pick a service'; $('msg').className = 'err'; return; }

  const serviceId = await resolveServiceIdByName(name);
  if (!serviceId) { $('msg').textContent = '❌ Could not match this service to provider'; $('msg').className = 'err'; return; }

  $('msg').textContent = 'Placing order...';

  const r = await api(`${BASE}/api/smm`, {
    method:'POST',
    body: JSON.stringify({ action:'add', service: serviceId, link: target, quantity: qty })
  });

  if (r.ok && r.json && r.json.order) {
    $('msg').className = 'ok';
    $('msg').textContent = `✅ Order ${r.json.order} placed.`;
    refreshBalance();
  } else {
    const err = r.json?.error || r.text || 'error';
    $('msg').className = 'err';
    $('msg').textContent = `❌ ${err}`;
  }
};

async function addFunds(method, cents){
  {
    const { uid, email } = currentUser();
    if (!uid || !email){ $('msg').textContent = '❌ Sign in (or enter User ID + Email) first'; $('msg').className = 'err'; return; }
  }
  const path = method==='coinbase' ? '/api/deposits/create-coinbase' : '/api/deposits/create-square';
  const r = await api(`${BASE}${path}`, { method:'POST', body: JSON.stringify({ amount_cents: cents }) });
  const url = r.json?.url;
  if (url) {
    $('msg').innerHTML = `Link created: <a href="${url}" target="_blank" rel="noopener">${url}</a>`;
  } else {
    $('msg').textContent = r.json?.error || 'Could not create link';
    $('msg').className = 'err';
  }
}

$('add5').onclick = () => addFunds('square',500);
$('add5c').onclick = () => addFunds('coinbase',500);
$('addCustom').onclick = () => {
  const v = prompt('Add funds (USD):', '10');
  const dollars = Math.max(0, Number(v||0));
  if (!dollars) return;
  // default to Square; change to coinbase if preferred
  addFunds('square', Math.round(dollars*100));
};

// init
(async function init(){
  applyUser();
  await bootstrapAuth();
  await refreshBalance();
  await loadCSV();
  const qp = params();
  // Preselect by name/slug/index if present
  let picked = null;
  if (qp.idx && catalog[Number(qp.idx)]) picked = catalog[Number(qp.idx)];
  if (!picked && qp.slug) picked = byName.get(String(qp.slug).toLowerCase()) || byName.get(String(qp.slug));
  if (!picked && qp.name) picked = findServiceFromQuery(qp.name);
  // Choose the option matching the picked record
  if (picked){
    const el = $('svc');
    const match = Array.from(el.options).find(o => o.dataset.slug === picked.slug);
    if (match) match.selected = true;
    // auto-filter to its category so the list is smaller
    $('fcat').value = picked.category || '';
  }
  applyFilters();
  // Pre-fill target URL if supplied
  if (qp.link) $('url').value = qp.link;
  estimate();
})();
</script>
</body>
</html>