<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>DropSource — Balance</title>
  <style>
    body { background:#0b0b0f; color:#e8ecf1; font:16px system-ui; padding:2rem; }
    .ok { color:#4caf50; }
    .canceled { color:#f44336; }
    .muted { color:#a6acb3; }
    .row { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
    .balance { margin-top:1rem; font-size:1.2rem; }
    button { background:#11131a; border:1px solid #24262c; color:#e8ecf1; padding:.5rem .75rem; border-radius:10px; cursor:pointer }
    button:hover { border-color:#59a0ff; }
    .pillbar { display:flex; gap:.5rem; flex-wrap:wrap; margin:.5rem 0 0; }
    .pillbar button { background:#141722; border:1px solid #2a2e3a; border-radius:999px; padding:.35rem .75rem; font-weight:600; }
    .pillbar button:hover { border-color:#59a0ff; }
    .providers { display:flex; gap:.5rem; margin-top:.5rem; flex-wrap:wrap; }
    .providers button { background:#ffd85a; color:#111; border:1px solid #e3b900; border-radius:10px; padding:.5rem .75rem; font-weight:700; }
    .providers button.secondary { background:#2ee4b6; border-color:#10c59b; color:#072319; }
    .field { display:flex; align-items:center; gap:.5rem; margin-top:.5rem; }
    .field input { background:#11131a; border:1px solid #24262c; color:#e8ecf1; padding:.5rem .75rem; border-radius:10px; min-width:10rem; }
    .field input:focus { outline:none; border-color:#59a0ff; }
    .note { margin-top:.25rem; color:#a6acb3; font-size:.9rem; }
    .divider { height:1px; background:#1b1f29; border:none; margin:1rem 0; }
  </style>
</head>
<body>
  <h1>Deposit Status</h1>
  <div id="status">Checking…</div>
  <div class="row" style="margin-top:.5rem">
    <div id="who" class="muted"></div>
    <button id="refresh">Refresh balance</button>
  </div>
  <div class="balance" id="balance"></div>

  <hr class="divider"/>

  <h2>Add funds</h2>
  <div id="addFunds">
    <div class="field">
      <label for="amt"><span class="muted">Amount (USD)</span></label>
      <input id="amt" type="number" step="1" min="1" placeholder="20" inputmode="numeric"/>
    </div>
    <div class="pillbar">
      <button type="button" data-amt="1">+$1</button>
      <button type="button" data-amt="10">+$10</button>
      <button type="button" data-amt="20">+$20</button>
      <button type="button" data-amt="50">+$50</button>
      <button type="button" data-amt="100">+$100</button>
    </div>
    <div class="providers">
      <button id="pay-square" type="button">Pay with Card (Square)</button>
      <button id="pay-coinbase" class="secondary" type="button">Pay with Crypto (Coinbase)</button>
    </div>
    <div id="msg" class="note"></div>
  </div>

  <script>
    // ——— helpers ———
    function getCookie(name){
      return document.cookie.split(';').map(s=>s.trim()).reduce((acc,p)=>{
        const i=p.indexOf('='); if(i>0){ acc[p.slice(0,i)] = decodeURIComponent(p.slice(i+1)); } return acc;
      }, {})[name];
    }
    function setCookie(name, value, maxAgeSec){
      document.cookie = `${name}=${encodeURIComponent(value)}; path=/; max-age=${maxAgeSec||2592000}; SameSite=Lax`;
    }
    function fmtUSD(cents){
      const n = Number(cents||0)/100;
      try { return n.toLocaleString(undefined,{style:'currency',currency:'USD'}); } catch { return `$${n.toFixed(2)}`; }
    }

    // ——— identity ———
    const KEY = 'ds_user';
    function loadUser(){ try{ return JSON.parse(localStorage.getItem(KEY)||'{}'); }catch{ return {}; } }

    const params = new URLSearchParams(location.search);
    const local = loadUser();
    let uid   = params.get('uid')   || getCookie('uid')   || local.uid   || '';
    let email = params.get('email') || getCookie('email') || local.email || '';

    // If provided via query, persist to cookies for future hits (and mirror into local storage)
    if (params.get('uid')) {
      setCookie('uid', uid);
      localStorage.setItem(KEY, JSON.stringify({ ...(local||{}), uid, email: (local.email||email)||'' }));
    }
    if (params.get('email')) {
      setCookie('email', email);
      localStorage.setItem(KEY, JSON.stringify({ ...(local||{}), uid: (local.uid||uid)||'', email }));
    }

    // Show who context (obfuscated email)
    const whoEl = document.getElementById('who');
    if (uid || email) {
      const obEmail = email ? email.replace(/(^.).*(@.*$)/, (m,a,b)=> a+'***'+b) : '';
      whoEl.textContent = `User: ${uid || '—'}  ${obEmail ? `• ${obEmail}` : ''}`;
    } else {
      whoEl.textContent = 'User: not set (open from your checkout link so we know who to credit)';
    }

    // ——— status banner ———
    const statusEl = document.getElementById('status');
    if (params.has('ok')) {
      statusEl.innerHTML = '<span class="ok">✅ Payment successful! Waiting for credit…</span> <span class="muted">(auto-refreshing)</span>';
    } else if (params.has('canceled')) {
      statusEl.innerHTML = '<span class="canceled">❌ Payment canceled.</span>';
    } else {
      statusEl.textContent = 'Ready';
    }

    const balEl = document.getElementById('balance');

    async function fetchBalance(){
      if (!uid) { balEl.textContent = 'Sign in on the home page, then return to see your balance.'; return; }
      try {
        const r = await fetch('/api/wallet/get', {
          method:'GET',
          headers: { 'x-user-id': uid, 'x-user-email': email || '' },
          cache: 'no-store'
        });
        const data = await r.json();
        const dollars = fmtUSD(data.balance_cents);
        balEl.textContent = `Current balance: ${dollars} ${String(data.currency||'usd').toUpperCase()}`;
      } catch(e){
        console.error(e);
        balEl.textContent = '⚠️ Could not load balance';
      }
    }

    // ——— deposit helpers ———
    function dollarsToCents(v){
      const n = Math.max(0, Number(v||0));
      return Math.round(n * 100);
    }

    function successUrl(){
      const base = location.origin + '/balance.html';
      const q = new URLSearchParams();
      if (uid) q.set('uid', uid);
      if (email) q.set('email', email);
      q.set('ok', '1');
      return base + '?' + q.toString();
    }
    function cancelUrl(){
      const base = location.origin + '/balance.html';
      const q = new URLSearchParams();
      if (uid) q.set('uid', uid);
      if (email) q.set('email', email);
      q.set('canceled', '1');
      return base + '?' + q.toString();
    }

    async function createCheckout(provider, amountDollars){
      const msg = document.getElementById('msg');
      if (!uid) { msg.textContent = 'Please sign in on the home page first.'; return; }

      const cents = dollarsToCents(amountDollars);
      if (!cents || cents < 100) { // $1 min guard
        msg.textContent = 'Enter at least $1 to continue.';
        return;
      }

      msg.textContent = '';

      try {
        const endpoint =
          provider === 'square'
            ? '/api/deposits/create-square'
            : provider === 'coinbase'
            ? '/api/deposits/create-coinbase'
            : `/api/deposits/create-${provider}`;

        const r = await fetch(endpoint, {
          method:'POST',
          headers:{
            'content-type':'application/json',
            'x-user-id': uid,
            'x-user-email': email || ''
          },
          body: JSON.stringify({
            amount_cents: cents,
            success_url: successUrl(),
            cancel_url: cancelUrl()
          })
        });

        let data = {};
        try { data = await r.json(); } catch {}
        if (!r.ok) {
          const serverMsg = (data && (data.error || data.message)) || '';
          throw new Error(serverMsg || `HTTP ${r.status}`);
        }

        const url = data.url || data.checkout_url || data.hosted_url;
        if (!url) throw new Error('No checkout URL returned');
        location.href = url;
      } catch (err){
        console.error(err);
        msg.textContent = '⚠️ Checkout failed: ' + (err.message || 'Could not start checkout');
      }
    }

    // quick amount chips
    document.querySelectorAll('.pillbar [data-amt]').forEach(btn => {
      btn.addEventListener('click', () => {
        const v = btn.getAttribute('data-amt');
        const inp = document.getElementById('amt');
        inp.value = v;
      });
    });

    // provider buttons
    document.getElementById('pay-square').addEventListener('click', () => {
      const amt = (document.getElementById('amt').value || '0').trim();
      createCheckout('square', amt);
    });
    document.getElementById('pay-coinbase').addEventListener('click', () => {
      const amt = (document.getElementById('amt').value || '0').trim();
      createCheckout('coinbase', amt);
    });

    // manual refresh button
    document.getElementById('refresh').addEventListener('click', fetchBalance);

    // initial fetch
    fetchBalance();

    // short auto-poll after success so wallet shows up without manual refresh
    if (params.has('ok')) {
      let tries = 0; const maxTries = 20; // ~60s at 3s interval
      const iv = setInterval(async ()=>{
        tries++;
        await fetchBalance();
        if (tries >= maxTries) clearInterval(iv);
      }, 3000);
    }
  </script>
</body>
</html>